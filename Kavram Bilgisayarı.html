<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kavram Bilgi Yarışması</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2f7; /* Light blue background */
            /* Removed display: flex; justify-content: center; align-items: center; */
            min-height: 100vh; /* Ensure body takes full height */
            margin: 0;
            padding: 0;
            box-sizing: border-box; /* Corrected from 'border' */
            overflow-x: hidden;
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        .container {
            background-color: #ffffff;
            border-radius: 0;
            box-shadow: none;
            max-width: 100%;
            width: 100%;
            min-height: 100vh; /* Ensure container takes at least full height */
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            padding: 2.5rem 1rem;
            box-sizing: border-box;
            overflow-y: auto; /* Enable scrolling for content within the container */
            padding-top: 2rem; /* Başlık için üstten boşluk */
            margin: 0 auto; /* Center the container horizontally */
        }
        .concept-box {
            min-width: 120px;
            max-width: 220px;
            min-height: 110px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #000000;
            font-size: 1.05rem;
            font-weight: bold;
            border-radius: 9999px;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border: 3px solid transparent;
            cursor: pointer;
            position: relative;
            animation: bubbleFloat var(--animation-duration) ease-in-out var(--animation-delay) infinite alternate;
        }
        .concept-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: inherit;
            background: radial-gradient(circle at 25% 25%, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 70%);
            pointer-events: none;
            z-index: 1;
        }
        .concept-box span {
            position: relative;
            z-index: 2;
            padding: 0.75rem 1rem;
            text-align: center;
            word-break: break-word;
            overflow-wrap: break-word;
            line-height: 1.2;
            display: block;
        }

        .concept-box:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .concept-box.correct {
            background-color: #10B981;
            border-color: #047857;
            box-shadow: 0 0 35px rgba(16, 185, 129, 1);
            border-width: 5px;
            border-style: solid;
            transform: scale(1.08);
        }
        .concept-box.incorrect {
            border-color: #EF4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.6);
        }
        .quiz-area {
            width: 100%;
            max-width: none;
            text-align: left;
            background: linear-gradient(to right, #A8D8FF, #4D94FF);
            border: 3px dashed #67a9cf;
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .question-line {
            display: flex;
            align-items: baseline;
            margin-bottom: 1.5rem;
            width: 100%;
        }
        .question-line h2 {
            margin-right: 0.5rem;
            margin-bottom: 0;
            flex-shrink: 0;
            font-size: 2.25rem;
        }
        .question-line p {
            flex-grow: 1;
            margin-bottom: 0;
            font-size: 1.5rem;
        }

        .message-box {
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1rem;
            font-weight: 600;
            text-align: center;
            width: 100%;
        }
        .message-box.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .message-box.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .action-button {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            width: 100%;
        }
        .action-button:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }
        .action-button:active {
            transform: translateY(0);
        }
        .button-group {
            display: flex;
            gap: 1rem;
            width: 100%;
            max-width: none;
            margin-top: 2rem;
            margin-bottom: 1rem;
            justify-content: center;
        }
        .button-group .action-button {
            flex: 1;
        }
        .reset-button {
            background-color: #6b7280;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            width: 100%;
            max-width: none;
        }
        .reset-button:hover {
            background-color: #4b5563;
        }

        /* Responsive grid for concept boxes */
        .concept-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            justify-content: center;
            gap: 1rem;
        }

        /* Timer display style */
        #timerDisplay {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3b82f6;
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            text-align: center;
            padding: 0.5rem 1rem;
            background-color: transparent;
            border-radius: 0.5rem;
            box-shadow: none;
            z-index: 10;
        }
        #timerDisplay.warning {
            color: #EF4444;
        }

        /* Checkmark icon style */
        .concept-box .checkmark {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .concept-box.correct .checkmark {
            opacity: 1;
        }


        /* Media queries for responsive column reduction/expansion */
        @media (max-width: 1200px) {
            .concept-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }
        @media (max-width: 992px) {
            .concept-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        @media (max-width: 768px) {
            .concept-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (max-width: 640px) {
            .concept-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 480px) {
            .concept-grid {
                grid-template-columns: repeat(1, 1fr);
            }
        }

        /* Bubble animation definition */
        @keyframes bubbleFloat {
            0% { transform: translate(0px, 0px) scale(1); opacity: 0.9; }
            50% { transform: translate(var(--translate-x), var(--translate-y)) scale(1.02); opacity: 0.95; }
            100% { transform: translate(0px, 0px) scale(1); opacity: 0.9; }
        }

        /* Unit selection screen styles */
        #mainMenuScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
            padding: 2rem;
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        /* New unit grid style */
        .unit-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* Default 3 columns */
            gap: 1.5rem; /* Gap between cards */
            width: 90%; /* Occupy more width */
            max-width: 1200px; /* Max width for the grid */
            justify-items: center; /* Center items in the grid */
            margin: 0 auto; /* Added to center the grid itself */
            flex-grow: 1; /* Allow unit grid to grow and push button down */
            align-items: center; /* Center items vertically within the grid area */
        }
        .unit-card {
            padding: 1.5rem;
            border-radius: 1rem;
            width: 100%; /* Take full width of its grid column */
            aspect-ratio: 4/3; /* Maintain aspect ratio for better visual consistency */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            font-size: 1.25rem;
            font-weight: 600;
            color: #333; /* Darker text for better contrast on gradients */
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(0,0,0,0.1); /* Subtle border */
        }
        .unit-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .unit-card.selected {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6), 0 0 0 3px #3b82f6; /* Blue glow and thicker border */
            border-color: #3b82f6;
        }
        .main-quiz-content {
            display: none; /* Hidden by default */
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
        }

        /* Editor specific styles - These are hidden in normal mode */
        #editorScreen {
            display: none;
        }
        .editor-section {
            display: none;
        }
        .editor-list-item {
            display: none;
        }
        .editor-controls {
            display: none;
        }
        .editor-form {
            display: none;
        }
        .editor-form-buttons {
            display: none;
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .modal-content h4 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
        }
        .modal-content input[type="text"], .modal-content textarea {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #ccc;
            font-size: 1rem;
            width: 100%;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        .modal-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .modal-save-btn {
            background-color: #3b82f6;
            color: white;
        }
        .modal-save-btn:hover {
            background-color: #2563eb;
        }
        .modal-cancel-btn {
            background-color: #6b7280;
            color: white;
        }
        .modal-cancel-btn:hover {
            background-color: #4b5563;
        }
        .modal-confirm-btn {
            background-color: #f44336;
            color: white;
        }
        .modal-confirm-btn:hover {
            background-color: #da190b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl font-bold text-gray-800 mb-6">Kavram Bilgi Yarışması</h1>
        <div id="mainMenuScreen">
            <div id="unitCardsContainer" class="unit-grid">
            </div>
            <button id="startQuizBtn" class="action-button px-8 py-3 text-xl" style="display: none;">Yarışmayı Başlat</button>
            <button id="returnToIndexBtn" class="action-button bg-blue-500 hover:bg-blue-700 mt-4 px-8 py-3 text-xl">Ana Sayfaya Dön</button>
        </div>
        <div id="mainQuizContent" class="main-quiz-content">
            <div id="quizArea" class="quiz-area">
                <div class="question-line">
                    <h2 class="text-3xl font-bold text-gray-700">Soru:</h2>
                    <p id="questionText" class="text-xl text-gray-800"></p>
                </div>
                <div id="timerDisplay">50</div>
                <div id="feedback" class="message-box mt-4" style="display: none;"></div>
            </div>
            <div id="conceptBoxes" class="concept-grid w-full justify-items-center">
            </div>
            <div class="button-group">
                <button id="showAnswerBtn" class="action-button bg-gray-500 hover:bg-gray-700">Cevabı Göster</button>
                <button id="nextQuestionBtn" class="action-button">Sonraki Soru</button>
            </div>
            <button id="resetQuizBtn" class="reset-button">Yarışmayı Yeniden Başlat</button>
            <button id="returnToMainMenuFromQuizBtn" class="action-button bg-gray-500 hover:bg-gray-700 mt-4">Ana Menüye Dön</button>
            <button id="returnToIndexFromQuizBtn" class="action-button bg-blue-500 hover:bg-blue-700 mt-4">Ana Sayfaya Dön</button>
        </div>
        <div id="editorScreen" style="display: none;"></div>
    </div>

    <div id="customModalOverlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h4 id="modalTitle"></h4>
            <p id="modalMessage" class="text-gray-700"></p>
            <input type="text" id="modalInput1" style="display: none;">
            <input type="text" id="modalInput2" style="display: none;">
            <textarea id="modalTextarea" style="display: none;"></textarea>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="modal-confirm-btn" style="display: none;">Evet</button>
                <button id="modalSaveBtn" class="modal-save-btn" style="display: none;">Kaydet</button>
                <button id="modalCancelBtn" class="modal-cancel-btn">İptal</button>
            </div>
        </div>
    </div>

    <script>
        // Ünite ve kavram verileri
        // Bu veriler 5. sınıf Din Kültürü ve Ahlak Bilgisi müfredatına uygun olarak hazırlanmıştır.
        let units = [
            {
                id: 'unit1',
                name: 'Ünite 1: Allah İnancı',
                concepts: [
                    { id: 'evrendeki-mukemmel-duzen', name: 'Evrendeki Mükemmel Düzen', color: 'bg-blue-600', questions: [
                        { question: 'Evrendeki hiçbir şeyin tesadüfen olmadığını, aksine her şeyin mükemmel bir düzen içinde gerçekleştiğini gösteren durum nedir?' },
                        { question: 'Gezegenlerden insanlara, bitkilerden hayvanlara kadar her varlığın belirli bir düzen içinde var olması neyi gösterir?' }
                    ]},
                    { id: 'allahin-varligi-ve-birligi', name: 'Allah\'ın Varlığı ve Birliği (Tevhit)', color: 'bg-green-600', questions: [
                        { question: 'İslam dininin temel inanç ilkesi olan, Allah\'ın bir ve tek olduğuna inanma prensibi nedir?' },
                        { question: 'Allah\'ın eşi ve benzeri olmaması, O\'nun hangi özelliğini vurgular?' }
                    ]},
                    { id: 'esmaul-husna', name: 'Allah\'ın Güzel İsimleri (Esmaül Hüsna)', color: 'bg-yellow-600', questions: [
                        { question: 'Allah\'ın "Her şeyi gören" anlamına gelen ismi nedir?' },
                        { question: 'Allah\'ın "Her şeyi işiten" anlamına gelen ismi nedir?' },
                        { question: 'Allah\'ın "Her şeye gücü yeten" anlamına gelen ismi nedir?' },
                        { question: 'Allah\'ın "Çok merhametli" anlamına gelen ismi nedir?' },
                        { question: 'Allah\'ın "Her şeye muhtaç olmayan, her şeyin kendisine muhtaç olduğu" anlamına gelen ismi nedir?' }
                    ]},
                    { id: 'ihlas-suresi', name: 'İhlas Suresi ve Anlamı', color: 'bg-red-600', questions: [
                        { question: 'Hangi surede Allah\'ın birliği ve tekliği vurgulanır?' },
                        { question: 'İhlas Suresi\'nde Allah\'ın "doğurmadığı ve doğmadığı" ifadesi ne anlama gelir?' }
                    ]}
                ]
            },
            {
                id: 'unit2',
                name: 'Ünite 2: Namaz',
                concepts: [
                    { id: 'namazin-onemi', name: 'Namazın Önemi', color: 'bg-purple-600', questions: [
                        { question: 'İslam\'ın temel direği olarak kabul edilen ibadet hangisidir?' },
                        { question: 'Günde beş vakit kılınması farz olan ibadet hangisidir?' }
                    ]},
                    { id: 'namazin-farzlari', name: 'Namazın Farzları (Şartları ve Rükünleri)', color: 'bg-indigo-600', questions: [
                        { question: 'Namazda ayakta durmaya ne denir?' },
                        { question: 'Namazda Kur\'an okumaya ne denir?' },
                        { question: 'Namazda elleri dizlere koyarak eğilmeye ne denir?' },
                        { question: 'Namazda alnı yere koyarak kapanmaya ne denir?' },
                        { question: 'Namaza başlarken alınan tekbirin adı nedir?' },
                        { question: 'Namaz kılmadan önce bedenin, elbisenin ve namaz kılınacak yerin temiz olmasına ne denir?' },
                        { question: 'Namazda Kâbe yönüne dönmeye ne denir?' }
                    ]},
                    { id: 'abdest-ve-onemi', name: 'Abdest ve Önemi', color: 'bg-pink-600', questions: [
                        { question: 'Namaz kılmadan önce yapılan küçük temizliğe ne denir?' },
                        { question: 'Suyun bulunmadığı durumlarda temiz toprakla yapılan temizliğe ne denir?' }
                    ]}
                ]
            },
            {
                id: 'unit3',
                name: 'Ünite 3: Kur\'an-ı Kerim',
                concepts: [
                    { id: 'kurani-tanima', name: 'Kur\'an-ı Kerim\'i Tanıyalım', color: 'bg-teal-600', questions: [
                        { question: 'Allah\'ın son ilahi kitabı hangisidir?' },
                        { question: 'Kur\'an-ı Kerim\'i baştan sona ezberleyen kişiye ne denir?' }
                    ]},
                    { id: 'kurani-anlama', name: 'Kur\'an-ı Kerim\'i Anlama ve Yaşama', color: 'bg-cyan-600', questions: [
                        { question: 'Kur\'an-ı Kerim\'in indiriliş amacı nedir?' },
                        { question: 'Kur\'an\'da yer alan geçmiş peygamberlerin ve ümmetlerinin hayatlarıyla ilgili ibret verici olaylara ne denir?' }
                    ]}
                ]
            },
            {
                id: 'unit4',
                name: 'Ünite 4: Peygamber Kıssaları',
                concepts: [
                    { id: 'peygamber-kimdir', name: 'Peygamber Kimdir ve Görevleri', color: 'bg-orange-600', questions: [
                        { question: 'Allah\'tan vahiy alıp insanlara ileten kişilere ne denir?' },
                        { question: 'Peygamberlerin Allah\'tan aldıkları mesajları eksiksiz iletme görevine ne denir?' }
                    ]},
                    { id: 'bazi-kissalar', name: 'Bazı Peygamber Kıssaları', color: 'bg-brown-600', questions: [
                        { question: 'Hz. Nuh\'un kavmini tufandan kurtarmak için yaptığı büyük geminin adı nedir?' },
                        { question: 'Hz. İbrahim\'in ateşe atıldığı ancak Allah\'ın izniyle yanmadığı kıssa hangi peygamberle ilgilidir?' }
                    ]}
                ]
            },
            {
                id: 'unit5',
                name: 'Ünite 5: Mimari̇mi̇zde Di̇ni̇ Moti̇fler',
                concepts: [
                    { id: 'islam-mimarisi', name: 'İslam Sanatı ve Mimarisi', color: 'bg-gray-600', questions: [
                        { question: 'İslam mimarisinde camilerin üstünü örten yarım küre biçimindeki çatıya ne denir?' },
                        { question: 'Camilerde ezan okumak için yapılan yüksek, ince kulelere ne denir?' }
                    ]},
                    { id: 'cami-bolumleri', name: 'Cami Bölümleri', color: 'bg-blueGray-600', questions: [
                        { question: 'Camilerde imamın namaz kıldırırken durduğu, kıble yönünü gösteren yere ne denir?' },
                        { question: 'Cuma ve bayram namazlarında hatibin hutbe okuduğu basamaklı yere ne denir?' }
                    ]}
                ]
            }
        ];

        let selectedUnitId = null;
        let currentConceptIndex = 0;
        let currentQuestionIndex = 0;
        let score = 0;
        let totalQuestions = 0;
        let timerInterval;
        const initialTimerValue = 50; // Initial timer value in seconds
        let timer = initialTimerValue;

        const mainMenuScreen = document.getElementById('mainMenuScreen');
        const mainQuizContent = document.getElementById('mainQuizContent');
        const unitCardsContainer = document.getElementById('unitCardsContainer');
        const startQuizBtn = document.getElementById('startQuizBtn');
        const questionTextElement = document.getElementById('questionText');
        const conceptBoxesContainer = document.getElementById('conceptBoxes');
        const feedbackDiv = document.getElementById('feedback');
        const showAnswerBtn = document.getElementById('showAnswerBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const resetQuizBtn = document.getElementById('resetQuizBtn');
        const timerDisplay = document.getElementById('timerDisplay');
        const returnToMainMenuFromQuizBtn = document.getElementById('returnToMainMenuFromQuizBtn');
        const mainTitle = document.querySelector('h1'); // Get the main title element

        // New Home button elements
        const returnToIndexBtn = document.getElementById('returnToIndexBtn');
        const returnToIndexFromQuizBtn = document.getElementById('returnToIndexFromQuizBtn');

        // Custom Modal Elements
        const customModalOverlay = document.getElementById('customModalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const modalSaveBtn = document.getElementById('modalSaveBtn');
        const modalInput1 = document.getElementById('modalInput1');
        const modalInput2 = document.getElementById('modalInput2');
        const modalTextarea = document.getElementById('modalTextarea');

        // Function to show custom modal
        function showCustomModal(title, message, type, onConfirm, onCancel, input1Placeholder = '', input2Placeholder = '', textareaPlaceholder = '') {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            customModalOverlay.style.display = 'flex';

            modalInput1.style.display = 'none';
            modalInput2.style.display = 'none';
            modalTextarea.style.display = 'none';
            modalConfirmBtn.style.display = 'none';
            modalSaveBtn.style.display = 'none';
            modalCancelBtn.style.display = 'inline-block'; // Always show cancel for now

            if (type === 'confirm') {
                modalConfirmBtn.style.display = 'inline-block';
                modalConfirmBtn.onclick = () => {
                    hideCustomModal();
                    if (onConfirm) onConfirm();
                };
                modalCancelBtn.onclick = () => {
                    hideCustomModal();
                    if (onCancel) onCancel();
                };
            } else if (type === 'input') {
                modalInput1.style.display = 'block';
                modalInput1.placeholder = input1Placeholder;
                modalInput2.style.display = 'block';
                modalInput2.placeholder = input2Placeholder;
                modalSaveBtn.style.display = 'inline-block';
                modalSaveBtn.onclick = () => {
                    hideCustomModal();
                    if (onConfirm) onConfirm(modalInput1.value, modalInput2.value);
                };
                modalCancelBtn.onclick = () => {
                    hideCustomModal();
                    if (onCancel) onCancel();
                };
            } else if (type === 'textarea') {
                modalTextarea.style.display = 'block';
                modalTextarea.placeholder = textareaPlaceholder;
                modalSaveBtn.style.display = 'inline-block';
                modalSaveBtn.onclick = () => {
                    hideCustomModal();
                    if (onConfirm) onConfirm(modalTextarea.value);
                };
                modalCancelBtn.onclick = () => {
                    hideCustomModal();
                    if (onCancel) onCancel();
                };
            } else { // 'alert' type
                modalCancelBtn.onclick = hideCustomModal;
            }
        }

        // Function to hide custom modal
        function hideCustomModal() {
            customModalOverlay.style.display = 'none';
            modalInput1.value = '';
            modalInput2.value = '';
            modalTextarea.value = '';
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function renderUnitCards() {
            unitCardsContainer.innerHTML = '';
            units.forEach(unit => {
                const unitCard = document.createElement('div');
                unitCard.classList.add('unit-card', 'shadow-lg', 'hover:shadow-xl');
                unitCard.style.background = `linear-gradient(to bottom right, ${getUnitColor(unit.id, 0.7)}, ${getUnitColor(unit.id, 1)})`;
                unitCard.textContent = unit.name;
                unitCard.dataset.unitId = unit.id;

                if (selectedUnitId === unit.id) {
                    unitCard.classList.add('selected');
                }

                unitCard.addEventListener('click', () => {
                    selectedUnitId = unit.id;
                    renderUnitCards(); // Update selection visual
                    startQuizBtn.style.display = 'block'; // Show start quiz button
                });
                unitCardsContainer.appendChild(unitCard);
            });
        }

        function getUnitColor(unitId, opacity = 1) {
            switch (unitId) {
                case 'unit1': return `rgba(59, 130, 246, ${opacity})`; // Blue
                case 'unit2': return `rgba(139, 92, 246, ${opacity})`; // Purple
                case 'unit3': return `rgba(16, 185, 129, ${opacity})`; // Teal
                case 'unit4': return `rgba(245, 158, 11, ${opacity})`;  // Orange
                case 'unit5': return `rgba(107, 114, 128, ${opacity})`; // Gray
                case 'all-units': return `rgba(239, 68, 68, ${opacity})`; // Red for all units
                default: return `rgba(100, 116, 139, ${opacity})`; // Slate
            }
        }

        function startQuiz() {
            if (!selectedUnitId) {
                showCustomModal('Uyarı', 'Lütfen önce bir ünite seçin!', 'alert');
                return;
            }

            mainMenuScreen.style.display = 'none';
            mainTitle.style.display = 'none'; // Hide the main title when quiz starts
            mainQuizContent.style.display = 'flex';
            resetQuiz();
            loadConceptsForQuiz();
        }

        function loadConceptsForQuiz() {
            const selectedUnit = units.find(unit => unit.id === selectedUnitId);
            if (!selectedUnit) {
                showCustomModal('Hata', 'Seçilen ünite bulunamadı!', 'alert');
                return;
            }

            // Combine all questions from all concepts within the selected unit
            let allQuestions = [];
            selectedUnit.concepts.forEach(concept => {
                allQuestions = allQuestions.concat(concept.questions.map(q => ({
                    ...q,
                    conceptId: concept.id,
                    conceptName: concept.name,
                    conceptColor: concept.color
                })));
            });

            shuffleArray(allQuestions);
            totalQuestions = allQuestions.length;
            currentConceptIndex = 0; // Reset concept index for quiz flow
            currentQuestionIndex = 0; // Reset question index for quiz flow

            if (totalQuestions === 0) {
                showCustomModal('Bilgi', 'Bu ünitede henüz soru bulunmamaktadır.', 'alert');
                returnToMainMenu();
                return;
            }
            displayQuestion();
        }

        function displayQuestion() {
            clearInterval(timerInterval);
            timer = initialTimerValue;
            timerDisplay.textContent = timer;
            timerDisplay.classList.remove('warning');
            timerDisplay.style.display = 'block';

            feedbackDiv.style.display = 'none';
            showAnswerBtn.style.display = 'inline-block';
            nextQuestionBtn.style.display = 'none';

            const selectedUnit = units.find(unit => unit.id === selectedUnitId);
            if (!selectedUnit || currentQuestionIndex >= totalQuestions) {
                showCustomModal('Bilgi', `Yarışma bitti! Toplam ${totalQuestions} sorudan ${score} doğru cevap verdiniz.`, 'alert');
                returnToMainMenu();
                return;
            }

            const currentQuestionData = selectedUnit.concepts.flatMap(c => c.questions.map(q => ({
                ...q,
                conceptId: c.id,
                conceptName: c.name,
                conceptColor: c.color
            })))[currentQuestionIndex];

            questionTextElement.textContent = currentQuestionData.question;
            renderConceptBoxes(currentQuestionData.conceptId, currentQuestionData.conceptColor);

            startTimer();
        }

        function renderConceptBoxes(correctConceptId, correctConceptColor) {
            conceptBoxesContainer.innerHTML = '';
            const allConcepts = units.flatMap(unit => unit.concepts);
            const shuffledConcepts = shuffleArray(allConcepts.filter(c => c.id !== correctConceptId));

            // Ensure the correct concept is always present
            const correctConcept = allConcepts.find(c => c.id === correctConceptId);
            if (correctConcept) {
                shuffledConcepts.splice(Math.floor(Math.random() * (shuffledConcepts.length + 1)), 0, correctConcept);
            }

            // Limit to a maximum of 10 concepts to display at once
            const conceptsToDisplay = shuffledConcepts.slice(0, 10);

            conceptsToDisplay.forEach((concept, index) => {
                const conceptBox = document.createElement('div');
                conceptBox.classList.add('concept-box', 'flex', 'items-center', 'justify-content', 'text-center', 'p-4', 'rounded-full', 'shadow-md', 'cursor-pointer');
                conceptBox.style.backgroundColor = concept.color; // Use concept's specific color
                conceptBox.style.setProperty('--animation-duration', `${2 + Math.random() * 2}s`);
                conceptBox.style.setProperty('--animation-delay', `${Math.random() * 0.5}s`);
                conceptBox.style.setProperty('--translate-x', `${(Math.random() - 0.5) * 10}px`);
                conceptBox.style.setProperty('--translate-y', `${(Math.random() - 0.5) * 10}px`);
                conceptBox.innerHTML = `<span>${concept.name}</span><svg class="checkmark" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`;
                conceptBox.dataset.conceptId = concept.id;

                conceptBox.addEventListener('click', () => checkAnswer(concept.id, correctConceptId, conceptBox));
                conceptBoxesContainer.appendChild(conceptBox);
            });
        }

        function checkAnswer(selectedConceptId, correctConceptId, selectedBox) {
            clearInterval(timerInterval); // Stop the timer once an answer is selected

            const allConceptBoxes = document.querySelectorAll('.concept-box');
            allConceptBoxes.forEach(box => {
                box.style.pointerEvents = 'none'; // Disable further clicks
                if (box.dataset.conceptId === correctConceptId) {
                    box.classList.add('correct');
                }
            });

            if (selectedConceptId === correctConceptId) {
                feedbackDiv.textContent = 'Doğru! 🎉';
                feedbackDiv.classList.remove('error');
                feedbackDiv.classList.add('success');
                score++;
            } else {
                feedbackDiv.textContent = 'Yanlış! Tekrar dene. 🤔';
                feedbackDiv.classList.remove('success');
                feedbackDiv.classList.add('error');
                selectedBox.classList.add('incorrect');
            }
            feedbackDiv.style.display = 'block';
            showAnswerBtn.style.display = 'none'; // Hide "Show Answer" button after answering
            nextQuestionBtn.style.display = 'inline-block'; // Show "Next Question" button
        }

        function startTimer() {
            timer = initialTimerValue;
            timerDisplay.textContent = timer;
            timerDisplay.classList.remove('warning');
            timerDisplay.style.display = 'block';

            timerInterval = setInterval(() => {
                timer--;
                timerDisplay.textContent = timer;
                if (timer <= 10) {
                    timerDisplay.classList.add('warning');
                }
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 1000);
        }

        function handleTimeout() {
            feedbackDiv.textContent = 'Süre doldu! Cevap veremediniz. ⌛';
            feedbackDiv.classList.remove('success');
            feedbackDiv.classList.add('error');
            feedbackDiv.style.display = 'block';

            const allConceptBoxes = document.querySelectorAll('.concept-box');
            allConceptBoxes.forEach(box => {
                box.style.pointerEvents = 'none'; // Disable further clicks
                const selectedUnit = units.find(unit => unit.id === selectedUnitId);
                const currentQuestionData = selectedUnit.concepts.flatMap(c => c.questions.map(q => ({
                    ...q,
                    conceptId: c.id,
                    conceptName: c.name,
                    conceptColor: c.color
                })))[currentQuestionIndex];
                if (box.dataset.conceptId === currentQuestionData.conceptId) {
                    box.classList.add('correct'); // Highlight the correct answer
                }
            });
            showAnswerBtn.style.display = 'none';
            nextQuestionBtn.style.display = 'inline-block';
        }

        function showAnswer() {
            clearInterval(timerInterval); // Stop the timer
            timerDisplay.style.display = 'none'; // Hide the timer

            const allConceptBoxes = document.querySelectorAll('.concept-box');
            allConceptBoxes.forEach(box => {
                box.style.pointerEvents = 'none'; // Disable further clicks
            });

            const selectedUnit = units.find(unit => unit.id === selectedUnitId);
            const currentQuestionData = selectedUnit.concepts.flatMap(c => c.questions.map(q => ({
                ...q,
                conceptId: c.id,
                conceptName: c.name,
                conceptColor: c.color
            })))[currentQuestionIndex];

            allConceptBoxes.forEach(box => {
                if (box.dataset.conceptId === currentQuestionData.conceptId) {
                    box.classList.add('correct');
                } else {
                    box.classList.add('incorrect'); // Mark others as incorrect if not the answer
                }
            });

            feedbackDiv.textContent = `Doğru cevap: "${currentQuestionData.conceptName}" idi.`;
            feedbackDiv.classList.remove('success');
            feedbackDiv.classList.add('error');
            feedbackDiv.style.display = 'block';
            showAnswerBtn.style.display = 'none'; // Hide "Show Answer" button
            nextQuestionBtn.style.display = 'inline-block'; // Show "Next Question" button
        }

        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        function resetQuiz() {
            score = 0;
            currentQuestionIndex = 0;
            totalQuestions = 0; // Will be recalculated in loadConceptsForQuiz
            clearInterval(timerInterval);
            timerDisplay.style.display = 'none';
            feedbackDiv.style.display = 'none';
            conceptBoxesContainer.innerHTML = '';
            questionTextElement.textContent = '';
            showAnswerBtn.style.display = 'inline-block';
            nextQuestionBtn.style.display = 'none';
        }

        function returnToMainMenu() {
            mainQuizContent.style.display = 'none';
            mainMenuScreen.style.display = 'flex';
            mainTitle.style.display = 'block'; // Show the main title again
            selectedUnitId = null; // Clear selected unit
            startQuizBtn.style.display = 'none'; // Hide start quiz button
            renderUnitCards(); // Render unit cards to show selection status correctly
        }

        // New function to return to index.html
        function returnToIndex() {
            window.location.href = '/'; // Changed to root path
        }

        // Event Listeners
        startQuizBtn.addEventListener('click', startQuiz);
        showAnswerBtn.addEventListener('click', showAnswer);
        nextQuestionBtn.addEventListener('click', nextQuestion);
        resetQuizBtn.addEventListener('click', resetQuiz);
        returnToMainMenuFromQuizBtn.addEventListener('click', () => {
            showCustomModal('Onay', 'Ana menüye dönmek istediğinizden emin misiniz? Mevcut ilerlemeniz kaybolacaktır.', 'confirm', returnToMainMenu, () => {});
        });

        // New Event Listeners for Home buttons
        returnToIndexBtn.addEventListener('click', returnToIndex);
        returnToIndexFromQuizBtn.addEventListener('click', () => {
            showCustomModal('Onay', 'Ana sayfaya dönmek istediğinizden emin misiniz? Mevcut ilerlemeniz kaybolacaktır.', 'confirm', returnToIndex, () => {});
        });


        // On application load
        document.addEventListener('DOMContentLoaded', () => {
            // Check if "Tüm Üniteler" option already exists
            const allUnitsExist = units.some(unit => unit.id === 'all-units');

            // Remove "Ek Kavramlar" unit from the units array (if it exists)
            units = units.filter(unit => unit.id !== 'additional-concepts-unit');

            if (!allUnitsExist) {
                // Combine concepts from all units in the units array
                const allConceptsCombined = units.flatMap(unit => unit.concepts);

                // Add a new "Tüm Üniteler" unit to the `units` array
                units.push({
                    id: 'all-units',
                    name: 'Tüm Üniteler',
                    concepts: allConceptsCombined
                });
            }

            // Initially, no unit should be selected; wait for the user to choose
            selectedUnitId = null;

            renderUnitCards(); // Render unit cards to display the main menu initially
            mainQuizContent.style.display = 'none'; // Ensure quiz content is hidden initially
            mainMenuScreen.style.display = 'flex'; // Ensure main menu is visible initially
            mainTitle.style.display = 'block'; // Ensure title is visible on initial load
        });
    </script>
</body>
</html>
