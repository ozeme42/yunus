import React, { useState, useEffect, createContext, useContext, useCallback, useRef } from 'react'; // useRef eklendi
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, addDoc, deleteDoc, getDocs } from 'firebase/firestore';

// Firebase yapılandırması ve global değişkenler
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-quiz-app';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; // Düzeltildi

// Firebase Context'i oluşturma
const FirebaseContext = createContext(null);

// Modal bileşeni (alert ve confirm yerine kullanılacak)
const Modal = ({ isOpen, onClose, title, message, onConfirm, showConfirmButton = false }) => {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-auto">
        <h3 className="text-xl font-semibold text-gray-900 mb-4 break-words">{title}</h3>
        <p className="text-gray-700 mb-6 break-words">{message}</p>
        <div className="flex justify-end space-x-3">
          {showConfirmButton && (
            <button
              onClick={onConfirm}
              className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors"
            >
              Onayla
            </button>
          )}
          <button
            onClick={onClose}
            className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
          >
            Kapat
          </button>
        </div>
      </div>
    </div>
  );
};

// Yeni: Toplu Soru Önizleme Modalı
const BulkQuestionPreviewModal = ({ isOpen, onClose, questions, errors, onConfirmSave, onCancel }) => {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-auto flex flex-col max-h-[90vh]">
        <h3 className="text-2xl font-semibold text-gray-900 mb-4 break-words">Toplu Soru Yükleme Önizlemesi</h3>

        {errors.length > 0 && (
          <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 overflow-y-auto max-h-40">
            <strong className="font-bold break-words">Hatalar:</strong>
            <ul className="list-disc list-inside mt-2">
              {errors.map((err, idx) => <li key={idx} className="text-sm break-words">{err}</li>)}
            </ul>
          </div>
        )}

        {questions.length > 0 ? (
          <>
            <p className="text-gray-700 mb-4 break-words">{questions.length} adet soru yüklenecek.</p>
            <div className="flex-grow overflow-y-auto pr-2 mb-6">
              <ul className="space-y-3">
                {questions.map((q, index) => (
                  <li key={index} className="bg-gray-50 p-3 rounded-lg shadow-sm">
                    <p className="font-medium text-sm break-words">Soru: {q.text}</p>
                    <p className="text-gray-600 text-xs break-words">Doğru Cevap: {q.correctAnswer} | Puan: {q.points} | Zorluk: {q.difficulty}</p>
                    <p className="text-gray-600 text-xs break-words">Sınıf: {q.grade} | Ders: {q.subject}</p>
                  </li>
                ))}
              </ul>
            </div>
          </>
        ) : (
          <p className="text-gray-700 mb-6 break-words">Önizlenecek soru bulunamadı.</p>
        )}

        <div className="flex justify-end space-x-3 mt-auto">
          <button
            onClick={onCancel}
            className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
          >
            İptal
          </button>
          <button
            onClick={onConfirmSave}
            className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
            disabled={questions.length === 0 || errors.length > 0} // Hata varsa veya soru yoksa kaydetme butonu pasif
          >
            Kaydet
          </button>
        </div>
      </div>
    </div>
  );
};


// Ana uygulama bileşeni
export default function App() {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [loading, setLoading] = useState(true);
  const [currentView, setCurrentView] = useState('main'); // main, settings, unitSelection, studentManagement, tools, questionSource
  const [selectedStudent, setSelectedStudent] = useState(null); // Öğrenci seçimi hala öğrenci yönetimi için gerekli olabilir
  const [selectedUnit, setSelectedUnit] = useState(null); // Ünite seçimi hala ünite yönetimi için gerekli olabilir
  const [appSettings, setAppSettings] = useState(null); // Uygulama ayarları
  const [students, setStudents] = useState([]); // Öğrenci listesi
  const [units, setUnits] = useState([]); // Ünite listesi
  const [questions, setQuestions] = useState([]); // Bu state artık doğrudan quiz için kullanılmıyor, ancak diğer bileşenlere prop olarak geçebilir
  const [questionsByUnit, setQuestionsByUnit] = useState({}); // Tüm ünitelerin soruları
  const questionsByUnitUnsubscribes = useRef({}); // Dinamik soru dinleyicilerini yönetmek için

  const [initialStudentViewMode, setInitialStudentViewMode] = useState('select'); // 'select' or 'register' mode for StudentSelection
  const [unitToManageId, setUnitToManageId] = useState(null); // Yeni: QuestionSourceScreen'de önceden seçilecek ünite ID'si

  // Modal durumu
  const [modal, setModal] = useState({ isOpen: false, title: '', message: '', onConfirm: null, showConfirmButton: false });

  // Firebase başlatma ve kimlik doğrulama
  useEffect(() => {
    const initializeFirebase = async () => {
      try {
        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const authInstance = getAuth(app);

        setDb(firestore);
        setAuth(authInstance);

        // Kimlik doğrulama durumu değiştiğinde dinleyici
        const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
          if (user) {
            setUserId(user.uid);
          } else {
            // Kullanıcı yoksa anonim olarak oturum aç
            if (initialAuthToken) {
              await signInWithCustomToken(authInstance, initialAuthToken);
            } else {
              await signInAnonymously(authInstance);
            }
          }
          setLoading(false);
        });

        return () => unsubscribe();
      } catch (error) {
        console.error("Firebase başlatma hatası:", error);
        setModal({
          isOpen: true,
          title: 'Hata',
          message: `Uygulama başlatılamadı: ${error.message}`,
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        setLoading(false);
      }
    };

    initializeFirebase();
  }, []);

  // Kullanıcı ID'si değiştiğinde veya db/auth hazır olduğunda ayarları, öğrenci, ünite ve TÜM soruları dinle
  useEffect(() => {
    if (!db || !userId) return;

    const unsubscribes = [];

    // Ayarları dinle
    const settingsDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/appSettings`);
    const unsubscribeSettings = onSnapshot(settingsDocRef, (docSnap) => {
      if (docSnap.exists()) {
        setAppSettings(docSnap.data());
      } else {
        // Varsayılan ayarları kaydet
        const defaultSettings = {
          timePerQuestion: 30, // Soru başına varsayılan süre
          enableNegativeScoring: false, // Yanlış cevapta puan eksiltme
          enableFastAnswerBonus: false, // Hızlı cevap bonusu
          fastAnswerBonusTime: 5, // Bonus için maksimum süre
          fastAnswerBonusPoints: 10, // Bonus puan miktarı
          showAnswerOnWrong: true, // Yanlış cevapta doğru cevabı göster
          removeCorrectQuestions: false, // Doğru cevaplanan soruları gizle
        };
        setDoc(settingsDocRef, defaultSettings).catch(e => console.error("Varsayılan ayarları kaydederken hata:", e));
        setAppSettings(defaultSettings);
      }
    }, (error) => console.error("Ayarları dinlerken hata:", error));
    unsubscribes.push(unsubscribeSettings);

    // Öğrencileri dinle (kullanıcıya özel)
    const studentsColRef = collection(db, `artifacts/${appId}/users/${userId}/students`);
    const unsubscribeStudents = onSnapshot(studentsColRef, (snapshot) => {
      const studentList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setStudents(studentList);
    }, (error) => console.error("Öğrencileri dinlerken hata:", error));
    unsubscribes.push(unsubscribeStudents);

    // Üniteleri dinle VE her ünitenin sorularını dinle
    const unitsColRef = collection(db, `artifacts/${appId}/users/${userId}/units`);
    const unsubscribeUnits = onSnapshot(unitsColRef, (snapshot) => {
      const unitList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setUnits(unitList);

      // Eski ünite soruları dinleyicilerini temizle
      Object.values(questionsByUnitUnsubscribes.current).forEach(unsub => unsub());
      questionsByUnitUnsubscribes.current = {};
      setQuestionsByUnit({}); // Önceki soruları temizle

      // Her ünite için yeni sorular dinleyicileri kur
      unitList.forEach(unit => {
        const questionsColRef = collection(db, `artifacts/${appId}/users/${userId}/units/${unit.id}/questions`);
        const unsubscribeQuestionsForUnit = onSnapshot(questionsColRef, (qSnapshot) => {
          const unitQuestions = qSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setQuestionsByUnit(prev => ({
            ...prev,
            [unit.id]: unitQuestions
          }));
        }, (error) => console.error(`Ünite ${unit.name} sorularını dinlerken hata:`, error));
        questionsByUnitUnsubscribes.current[unit.id] = unsubscribeQuestionsForUnit;
      });
    }, (error) => console.error("Üniteleri dinlerken hata:", error));
    unsubscribes.push(unsubscribeUnits);

    return () => {
      unsubscribes.forEach(unsub => unsub());
      // Ana bileşen temizlendiğinde tüm soru dinleyicilerini de temizle
      Object.values(questionsByUnitUnsubscribes.current).forEach(unsub => unsub());
    };
  }, [db, userId]);

  // selectedUnit değiştiğinde, o üniteye ait soruları 'questions' state'ine aktar (Bu artık quiz için değil, genel bir referans olarak kalabilir)
  useEffect(() => {
    if (selectedUnit && questionsByUnit[selectedUnit.id]) {
      setQuestions(questionsByUnit[selectedUnit.id]);
    } else {
      setQuestions([]);
    }
  }, [selectedUnit, questionsByUnit]);

  // Ayarları güncelleme fonksiyonu (App bileşeni içinde tanımlandı)
  const handleUpdateSetting = async (key, value) => {
    if (!db || !userId) return;
    try {
      const settingsDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/appSettings`);
      await updateDoc(settingsDocRef, { [key]: value });
      setModal({
        isOpen: true,
        title: 'Başarılı',
        message: 'Ayar başarıyla güncellendi.',
        onClose: () => setModal({ ...modal, isOpen: false }),
      });
    } catch (e) {
      console.error("Ayar güncellerken hata:", e);
      setModal({
        isOpen: true,
        title: 'Hata',
        message: `Ayar güncellenirken bir hata oluştu: ${e.message}`,
        onClose: () => setModal({ ...modal, isOpen: false }),
      });
    }
  };

  // Uygulamayı sıfırlama fonksiyonu
  const handleResetApplication = async () => {
    if (!db || !userId) return;

    setModal({
      isOpen: true,
      title: 'Uygulamayı Sıfırla',
      message: 'Tüm öğrenci, ünite ve soru verileri silinecek. Bu işlem geri alınamaz. Emin misiniz?',
      showConfirmButton: true,
      onConfirm: async () => {
        try {
          // Öğrenci verilerini sil
          const studentsColRef = collection(db, `artifacts/${appId}/users/${userId}/students`);
          const studentDocs = await getDocs(studentsColRef);
          const studentDeletePromises = studentDocs.docs.map(d => deleteDoc(d.ref));
          await Promise.all(studentDeletePromises);

          // Ünite ve soruları sil
          const unitsColRef = collection(db, `artifacts/${appId}/users/${userId}/units`);
          const unitDocs = await getDocs(unitsColRef);
          for (const unitDoc of unitDocs.docs) {
            const questionsColRef = collection(db, `artifacts/${appId}/users/${userId}/units/${unitDoc.id}/questions`);
            const questionDocs = await getDocs(questionsColRef);
            const questionDeletePromises = questionDocs.docs.map(d => deleteDoc(d.ref));
            await Promise.all(questionDeletePromises);
            await deleteDoc(unitDoc.ref); // Üniteyi sil
          }

          // Ayarları sil
          const settingsDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/appSettings`);
          await deleteDoc(settingsDocRef);

          // Liderlik tablosundaki kullanıcı verisini sil (isteğe bağlı, genel liderlik tablosu)
          const leaderboardDocRef = doc(db, `artifacts/${appId}/public/data/leaderboard`, userId);
            const leaderboardDocSnap = await getDoc(leaderboardDocRef);
            if (leaderboardDocSnap.exists()) {
                await deleteDoc(leaderboardDocRef);
            }

          // State'leri sıfırla
          setStudents([]);
          setUnits([]);
          setQuestions([]);
          setQuestionsByUnit({}); // Yeni eklenen
          setAppSettings(null);
          setSelectedStudent(null);
          setSelectedUnit(null);
          setInitialStudentViewMode('select');
          setCurrentView('main');
          setUnitToManageId(null); // Yeni eklenen

          setModal({ ...modal, isOpen: false }); // Modalı kapat
          setModal({
            isOpen: true,
            title: 'Başarılı',
            message: 'Uygulama verileri başarıyla sıfırlandı.',
            onClose: () => setModal({ ...modal, isOpen: false }),
          });
        } catch (e) {
          console.error("Uygulama sıfırlanırken hata:", e);
          setModal({
            isOpen: true,
            title: 'Hata',
            message: `Uygulama sıfırlanırken bir hata oluştu: ${e.message}`,
            onClose: () => setModal({ ...modal, isOpen: false }),
          });
        }
      },
      onClose: () => setModal({ ...modal, isOpen: false }),
    });
  };

  // Ana Ekran Bileşeni (Artık soru deposuna yönlendiriyor)
  const MainScreen = useCallback(() => {
    const handleGoToQuestionSource = () => {
      setCurrentView('questionSource');
    };

    const handleOpenTools = () => {
      setCurrentView('tools');
    };

    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-4">
        {/* Leaderboard kaldırıldı */}
        <h1 className="text-4xl font-extrabold text-gray-800 mb-8 text-center leading-tight break-words">
          Bilgi Yarışması Yönetim Paneli
        </h1>
        <div className="flex flex-col space-y-6 w-full max-w-sm">
          <button
            onClick={handleGoToQuestionSource}
            className="w-full bg-green-600 text-white py-4 px-6 rounded-xl shadow-lg hover:bg-green-700 transition-all duration-300 transform hover:scale-105 font-bold text-lg"
          >
            Soru Deposu'na Git
          </button>
          <button
            onClick={handleOpenTools}
            className="w-full bg-purple-600 text-white py-4 px-6 rounded-xl shadow-lg hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 font-bold text-lg"
          >
            Araçlar
          </button>
        </div>
        {userId && (
          <p className="mt-8 text-sm text-gray-600 break-words">
            Kullanıcı Kimliği: <span className="font-mono">{userId}</span>
          </p>
        )}
      </div>
    );
  }, [userId]); // Leaderboard kaldırıldı

  // Öğrenci Seçim Bileşeni (Sadece öğrenci yönetimi için kullanılabilir, quiz başlatma yok)
  const StudentSelection = useCallback(({ initialMode }) => {
    const [isRegistering, setIsRegistering] = useState(initialMode === 'register');
    const [newStudentName, setNewStudentName] = useState('');
    const [newStudentSurname, setNewStudentSurname] = useState('');

    useEffect(() => {
      setIsRegistering(initialMode === 'register');
      setNewStudentName('');
      setNewStudentSurname('');
    }, [initialMode]);

    const handleRegisterStudent = async () => {
      if (!newStudentName.trim()) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Öğrenci adı boş olamaz.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      try {
        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/students`), {
          name: newStudentName.trim(),
          surname: newStudentSurname.trim(),
          score: 0,
          createdAt: new Date(),
        });
        setNewStudentName('');
        setNewStudentSurname('');
        setIsRegistering(false);
        setModal({
          isOpen: true,
          title: 'Başarılı',
          message: 'Öğrenci başarıyla kaydedildi.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      } catch (e) {
        console.error("Öğrenci kaydederken hata:", e);
        setModal({
          isOpen: true,
          title: 'Hata',
          message: `Öğrenci kaydedilirken bir hata oluştu: ${e.message}`,
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      }
    };

    const handleSelectStudent = (student) => {
      setSelectedStudent(student);
      // Öğrenci seçimi yapıldıktan sonra nereye gidecek? Şimdilik Ana Ekrana dönelim.
      setCurrentView('main');
      setModal({
        isOpen: true,
        title: 'Öğrenci Seçildi',
        message: `${student.name} ${student.surname} seçildi.`,
        onClose: () => setModal({ ...modal, isOpen: false }),
      });
    };

    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-4">
        <h1 className="text-3xl font-bold text-gray-800 mb-6 break-words">Öğrenci Seç veya Kaydet</h1>
        <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
          {isRegistering ? (
            <div className="space-y-4">
              <input
                type="text"
                placeholder="Öğrenci Adı"
                value={newStudentName}
                onChange={(e) => setNewStudentName(e.target.value)}
                className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
              />
              <input
                type="text"
                placeholder="Öğrenci Soyadı (İsteğe Bağlı)"
                value={newStudentSurname}
                onChange={(e) => setNewStudentSurname(e.target.value)}
                className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
              />
              <button
                onClick={handleRegisterStudent}
                className="w-full bg-green-600 text-white py-3 rounded-md hover:bg-green-700 transition-colors font-semibold"
              >
                Kaydet
              </button>
              <button
                onClick={() => setIsRegistering(false)}
                className="w-full bg-gray-300 text-gray-800 py-3 rounded-md hover:bg-gray-400 transition-colors font-semibold"
              >
                Vazgeç
              </button>
            </div>
          ) : (
            <>
              <h2 className="text-xl font-semibold text-gray-700 mb-4 break-words">Mevcut Öğrenciler</h2>
              {students.length === 0 ? (
                <p className="text-gray-600 mb-4 break-words">Henüz kayıtlı öğrenci yok.</p>
              ) : (
                <ul className="space-y-3 mb-6 max-h-60 overflow-y-auto pr-2">
                  {students.map((student) => (
                    <li key={student.id} className="flex items-center justify-between bg-gray-50 p-3 rounded-lg shadow-sm hover:bg-gray-100 transition-colors">
                      <span className="text-gray-800 font-medium break-words">{student.name} {student.surname}</span>
                      <button
                        onClick={() => handleSelectStudent(student)}
                        className="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors text-sm"
                      >
                        Seç
                      </button>
                    </li>
                  ))}
                </ul>
              )}
              <button
                onClick={() => setIsRegistering(true)}
                className="w-full bg-indigo-600 text-white py-3 rounded-md hover:bg-indigo-700 transition-colors font-semibold"
              >
                Yeni Öğrenci Kaydet
              </button>
            </>
          )}
          <button
            onClick={() => setCurrentView('main')}
            className="w-full mt-6 bg-gray-500 text-white py-3 rounded-md hover:bg-gray-600 transition-colors font-semibold"
          >
            Geri
          </button>
        </div>
      </div>
    );
  }, [db, userId, students, modal, setSelectedStudent, setCurrentView]);

  // Öğrenci Yönetimi Alt Bileşeni
  const StudentManagement = ({ db, userId, students, setModal, modal, setCurrentView }) => {
    const [editingStudent, setEditingStudent] = useState(null);
    const [editName, setEditName] = useState('');
    const [editSurname, setEditSurname] = useState('');
    const [editScore, setEditScore] = useState(0);

    const handleEditClick = (student) => {
      setEditingStudent(student);
      setEditName(student.name);
      setEditSurname(student.surname);
      setEditScore(student.score);
    };

    const handleSaveEdit = async () => {
      if (!editingStudent || !editName.trim()) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Öğrenci adı boş olamaz.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      try {
        const studentDocRef = doc(db, `artifacts/${appId}/users/${userId}/students`, editingStudent.id);
        await updateDoc(studentDocRef, {
          name: editName.trim(),
          surname: editSurname.trim(),
          score: Number(editScore),
        });
        setEditingStudent(null);
        setModal({
          isOpen: true,
          title: 'Başarılı',
          message: 'Öğrenci bilgileri güncellendi.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      } catch (e) {
        console.error("Öğrenci güncellerken hata:", e);
        setModal({
          isOpen: true,
          title: 'Hata',
          message: `Öğrenci güncellenirken bir hata oluştu: ${e.message}`,
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      }
    };

    const handleDeleteStudent = (studentId) => {
      setModal({
        isOpen: true,
        title: 'Öğrenci Sil',
        message: 'Bu öğrenciyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.',
        showConfirmButton: true,
        onConfirm: async () => {
          try {
            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/students`, studentId));
            setModal({ ...modal, isOpen: false }); // Modalı kapat
            setModal({
              isOpen: true,
              title: 'Başarılı',
              message: 'Öğrenci başarıyla silindi.',
              onClose: () => setModal({ ...modal, isOpen: false }),
            });
          } catch (e) {
            console.error("Öğrenci silerken hata:", e);
            setModal({
              isOpen: true,
              title: 'Hata',
              message: `Öğrenci silinirken bir hata oluştu: ${e.message}`,
              onClose: () => setModal({ ...modal, isOpen: false }),
            });
          }
        },
        onClose: () => setModal({ ...modal, isOpen: false }),
      });
    };

    return (
      <div className="bg-white p-6 rounded-xl shadow-md">
        <h3 className="text-2xl font-semibold text-gray-800 mb-4 break-words">Öğrenci Yönetimi</h3>
        {students.length === 0 ? (
          <p className="text-gray-600 mb-4 break-words">Henüz kayıtlı öğrenci yok.</p>
        ) : (
          <ul className="space-y-3 mb-6 max-h-80 overflow-y-auto pr-2">
            {students.map((student) => (
              <li key={student.id} className="flex flex-col sm:flex-row items-start sm:items-center justify-between bg-gray-50 p-4 rounded-lg shadow-sm">
                <div className="flex-grow mb-2 sm:mb-0">
                  <span className="text-gray-800 font-medium break-words">{student.name} {student.surname}</span>
                  <span className="text-gray-600 text-sm ml-2 break-words"> (Puan: {student.score})</span>
                </div>
                <div className="flex space-x-2">
                  <button
                    onClick={() => handleEditClick(student)}
                    className="bg-yellow-500 text-white px-3 py-1 rounded-md hover:bg-yellow-600 transition-colors text-sm"
                  >
                    Düzenle
                  </button>
                  <button
                    onClick={() => handleDeleteStudent(student.id)}
                    className="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition-colors text-sm"
                  >
                    Sil
                  </button>
                </div>
              </li>
            ))}
          </ul>
        )}

        {editingStudent && (
          <div className="mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50 space-y-3">
            <h4 className="text-lg font-semibold text-gray-800 break-words">Öğrenciyi Düzenle: {editingStudent.name}</h4>
            <input
              type="text"
              placeholder="Ad"
              value={editName}
              onChange={(e) => setEditName(e.target.value)}
              className="w-full p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
            />
            <input
              type="text"
              placeholder="Soyad"
              value={editSurname}
              onChange={(e) => setEditSurname(e.target.value)}
              className="w-full p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
            />
            <input
              type="number"
              placeholder="Puan"
              value={editScore}
              onChange={(e) => setEditScore(Number(e.target.value))}
              className="w-full p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
            />
            <div className="flex space-x-2 justify-end">
              <button
                onClick={handleSaveEdit}
                className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors text-sm"
              >
                Kaydet
              </button>
              <button
                onClick={() => setEditingStudent(null)}
                className="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors text-sm"
              >
                İptal
              </button>
            </div>
          </div>
        )}
        <button
          onClick={() => setCurrentView('tools')} // Geri tuşu ile araçlar ekranına dön
          className="w-full mt-6 bg-gray-500 text-white py-3 rounded-md hover:bg-gray-600 transition-colors font-semibold"
        >
          Geri
        </button>
      </div>
    );
  };

  // Ayarlar Bileşeni
  const Settings = useCallback(({ db, userId, appSettings, students, units, questions, setModal, modal, handleUpdateSetting, setCurrentView, questionsByUnit }) => {
    // Yerel durum olarak ayarları yönet
    const [localQuizSettings, setLocalQuizSettings] = useState(appSettings);

    // appSettings prop'u değiştiğinde yerel durumu güncelle
    useEffect(() => {
      setLocalQuizSettings(appSettings);
    }, [appSettings]);

    const handleLocalSettingChange = (key, value) => {
      setLocalQuizSettings(prev => ({ ...prev, [key]: value }));
    };

    const handleSaveQuizSettings = async () => {
      for (const key in localQuizSettings) {
        if (localQuizSettings.hasOwnProperty(key)) {
          await handleUpdateSetting(key, localQuizSettings[key]);
        }
      }
      setModal({
        isOpen: true,
        title: 'Başarılı',
        message: 'Ayarlar başarıyla kaydedildi.',
        onClose: () => setModal({ ...modal, isOpen: false }),
      });
    };

    return (
      <div className="flex flex-col items-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-4">
        <h1 className="text-3xl font-bold text-gray-800 mb-6 mt-4 break-words">Uygulama Ayarları</h1>
        <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-3xl">
          {localQuizSettings && (
            <div className="space-y-6">
              {/* Süre Belirleme */}
              <div className="bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 className="text-xl font-semibold text-gray-800 mb-3 break-words">Genel Ayarlar</h3>
                <div className="flex items-center justify-between py-2">
                  <label htmlFor="timePerQuestion" className="text-gray-700 break-words">Varsayılan Soru Süresi (Saniye):</label>
                  <input
                    id="timePerQuestion"
                    type="number"
                    min="5"
                    max="120"
                    value={localQuizSettings.timePerQuestion}
                    onChange={(e) => handleLocalSettingChange('timePerQuestion', Number(e.target.value))}
                    className="w-24 p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
                  />
                </div>
              </div>

              {/* Veri İstatistikleri */}
              <div className="bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 className="text-xl font-semibold text-gray-800 mb-3 break-words">Veri İstatistikleri</h3>
                <p className="text-gray-700 py-1 break-words">Toplam Ünite Sayısı: <span className="font-semibold">{units.length}</span></p>
                <p className="text-gray-700 py-1 break-words">Toplam Soru Sayısı: <span className="font-semibold">
                  {Object.values(questionsByUnit).reduce((total, unitQ) => total + unitQ.length, 0)}
                </span></p>
              </div>
            </div>
          )}
          <div className="flex justify-end space-x-4 mt-8">
            <button
              onClick={handleSaveQuizSettings}
              className="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors font-semibold"
            >
              Kaydet
            </button>
            <button
              onClick={() => setCurrentView('tools')}
              className="px-6 py-3 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-semibold"
            >
              Geri
            </button>
          </div>
        </div>
      </div>
    );
  }, [db, userId, appSettings, modal, handleUpdateSetting, setCurrentView, units.length, questionsByUnit]);

  // Yeni Araçlar Ekranı Bileşeni
  const ToolsScreen = useCallback(() => {
    return (
      <div className="flex flex-col items-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-4">
        <h1 className="text-3xl font-bold text-gray-800 mb-6 mt-4 break-words">Araçlar</h1>
        <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg space-y-6">
          <button
            onClick={() => setCurrentView('settings')}
            className="w-full bg-purple-600 text-white py-4 px-6 rounded-xl shadow-lg hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 font-bold text-lg"
          >
            Uygulama Ayarları
          </button>
          <button
            onClick={() => setCurrentView('studentManagement')}
            className="w-full bg-orange-600 text-white py-4 px-6 rounded-xl shadow-lg hover:bg-orange-700 transition-all duration-300 transform hover:scale-105 font-bold text-lg"
          >
            Öğrenci Yönetimi
          </button>
          <button
            onClick={() => setCurrentView('questionSource')}
            className="w-full bg-blue-600 text-white py-4 px-6 rounded-xl shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 font-bold text-lg"
          >
            Soru Kaynağı ve Yönetimi
          </button>
          <button
            onClick={handleResetApplication}
            className="w-full bg-red-600 text-white py-4 px-6 rounded-xl shadow-lg hover:bg-red-700 transition-all duration-300 transform hover:scale-105 font-bold text-lg"
          >
            Uygulamayı Sıfırla
          </button>
          <button
            onClick={() => setCurrentView('main')}
            className="w-full mt-6 bg-gray-500 text-white py-3 rounded-md hover:bg-gray-600 transition-colors font-semibold"
          >
            Geri
          </button>
        </div>
      </div>
    );
  }, [handleResetApplication]);


  // Ünite Seçim Ekranı Bileşeni (Artık quiz başlatmıyor, soru yönetimine yönlendiriyor)
  const UnitSelectionScreen = useCallback(({ setUnitToManageId }) => {
    const handleUnitSelect = (unit) => {
      setUnitToManageId(unit.id); // Seçilen üniteyi soru yönetimi için ayarla
      setCurrentView('questionSource'); // Soru yönetimi ekranına git
    };

    return (
      <div className="flex flex-col items-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-4">
        <h1 className="text-3xl font-bold text-gray-800 mb-6 mt-4 break-words">Ünite Seçimi</h1>
        <p className="text-gray-700 mb-6 text-center break-words">
          Sorularını yönetmek istediğiniz üniteyi seçin.
        </p>
        <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-3xl grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {units.length === 0 ? (
            <p className="col-span-full text-center text-gray-600 break-words">Henüz ünite tanımlanmamış. Soru Kaynağı ve Yönetimi sayfasından ünite ekleyebilirsiniz.</p>
          ) : (
            units.map((unit) => {
              const unitQuestionsCount = questionsByUnit[unit.id]?.length || 0;
              return (
                <button
                  key={unit.id}
                  onClick={() => handleUnitSelect(unit)}
                  className="bg-blue-500 text-white p-6 rounded-lg shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:scale-105 flex flex-col items-center justify-center text-center h-32"
                >
                  <span className="text-xl font-bold mb-2 break-words">{unit.name}</span>
                  <span className="text-sm break-words">{unit.grade ? `${unit.grade}. Sınıf - ` : ''}{unit.subject || 'Ders Belirtilmemiş'}</span>
                  <span className="text-sm break-words">{unitQuestionsCount} Soru</span>
                </button>
              );
            })
          )}
        </div>
        <button
          onClick={() => setCurrentView('main')}
          className="w-full max-w-sm mt-8 bg-gray-500 text-white py-3 rounded-md hover:bg-gray-600 transition-colors font-semibold"
        >
          Geri
        </button>
      </div>
    );
  }, [units, questionsByUnit, setUnitToManageId, setCurrentView]);

  // Soru Kaynağı ve Yönetimi Ekranı Bileşeni
  const QuestionSourceScreen = ({ db, userId, units, questionsByUnit, setModal, modal, setCurrentView, unitToManageId }) => {
    const [bulkFile, setBulkFile] = useState(null);
    const [bulkPreview, setBulkPreview] = useState([]);
    const [bulkErrors, setBulkErrors] = useState([]);
    const [selectedUnitForBulkUpload, setSelectedUnitForBulkUpload] = useState(null);
    const [selectedBulkGrade, setSelectedBulkGrade] = useState(''); // Yeni: Toplu yükleme sınıfı
    const [selectedBulkSubject, setSelectedBulkSubject] = useState(''); // Yeni: Toplu yükleme dersi
    const [selectedBulkDifficulty, setSelectedBulkDifficulty] = useState('Normal'); // Yeni: Toplu yükleme zorluk seviyesi
    const [selectedBulkPoints, setSelectedBulkPoints] = useState(10); // Yeni: Toplu yükleme puanı
    const [showBulkPreviewModal, setShowBulkPreviewModal] = useState(false); // Yeni: Önizleme modalını gösterme/gizleme

    // Yeni: Toplu indirme filtreleri
    const [selectedDownloadGrade, setSelectedDownloadGrade] = useState('');
    const [selectedDownloadSubject, setSelectedDownloadSubject] = useState('');
    const [selectedDownloadUnit, setSelectedDownloadUnit] = useState('');


    // Ünite Yönetimi State'leri
    const [newUnitName, setNewUnitName] = useState('');
    const [newUnitGrade, setNewUnitGrade] = useState(''); // Yeni: Sınıf
    const [newUnitSubject, setNewUnitSubject] = useState(''); // Yeni: Ders
    const [editingUnit, setEditingUnit] = useState(null);
    const [editUnitName, setEditUnitName] = useState('');
    const [editUnitGrade, setEditUnitGrade] = useState(''); // Yeni: Düzenleme Sınıf
    const [editUnitSubject, setEditUnitSubject] = useState(''); // Yeni: Düzenleme Ders
    const [selectedUnitForQuestions, setSelectedUnitForQuestions] = useState(null);

    // Soru Ekleme/Düzenleme State'leri
    const [showAddQuestionForm, setShowAddQuestionForm] = useState(false);
    const [currentQuestion, setCurrentQuestion] = useState(null); // Düzenlenen soru
    const [questionText, setQuestionText] = useState('');
    const [optionA, setOptionA] = useState('');
    const [optionB, setOptionB] = useState('');
    const [optionC, setOptionC] = useState('');
    const [optionD, setOptionD] = useState('');
    const [correctAnswer, setCorrectAnswer] = useState('');
    const [difficulty, setDifficulty] = useState('Normal');
    const [questionPoints, setQuestionPoints] = useState(10);

    // unitToManageId değiştiğinde selectedUnitForQuestions'ı güncelle
    useEffect(() => {
      if (unitToManageId && units.length > 0) {
        const unit = units.find(u => u.id === unitToManageId);
        if (unit) {
          setSelectedUnitForQuestions(unit);
        }
      }
    }, [unitToManageId, units]);


    // Tüm soruları tek bir listede toplama
    const allQuestions = Object.values(questionsByUnit).flat();

    // Helper functions for options
    const getOptionValue = (char) => {
      switch (char) {
        case 'A': return optionA;
        case 'B': return optionB;
        case 'C': return optionC;
        case 'D': return optionD;
        default: return '';
      }
    };

    const setOptionValue = (char, value) => {
      switch (char) {
        case 'A': setOptionA(value); break;
        case 'B': setOptionB(value); break;
        case 'C': setOptionC(value); break;
        case 'D': setOptionD(value); break;
        default: break;
      }
    };

    // Ünite Ekle/Düzenle/Sil Fonksiyonları
    const handleAddUnit = async () => {
      if (!newUnitName.trim() || !newUnitGrade || !newUnitSubject) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Ünite adı, sınıfı ve dersi boş olamaz.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      try {
        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/units`), {
          name: newUnitName.trim(),
          grade: newUnitGrade, // Yeni
          subject: newUnitSubject, // Yeni
          createdAt: new Date(),
        });
        setNewUnitName('');
        setNewUnitGrade('');
        setNewUnitSubject('');
        setModal({
          isOpen: true,
          title: 'Başarılı',
          message: 'Ünite başarıyla eklendi.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      } catch (e) {
        console.error("Ünite eklerken hata:", e);
        setModal({
          isOpen: true,
          title: 'Hata',
          message: `Ünite eklenirken bir hata oluştu: ${e.message}`,
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      }
    };

    const handleEditUnitClick = (unit) => {
      setEditingUnit(unit);
      setEditUnitName(unit.name);
      setEditUnitGrade(unit.grade || ''); // Varsayılan değer
      setEditUnitSubject(unit.subject || ''); // Varsayılan değer
    };

    const handleSaveUnitEdit = async () => {
      if (!editingUnit || !editUnitName.trim() || !editUnitGrade || !editUnitSubject) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Ünite adı, sınıfı ve dersi boş olamaz.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      try {
        const unitDocRef = doc(db, `artifacts/${appId}/users/${userId}/units`, editingUnit.id);
        await updateDoc(unitDocRef, {
          name: editUnitName.trim(),
          grade: editUnitGrade,
          subject: editUnitSubject,
        });
        setEditingUnit(null);
        setModal({
          isOpen: true,
          title: 'Başarılı',
          message: 'Ünite adı güncellendi.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      } catch (e) {
        console.error("Ünite güncellerken hata:", e);
        setModal({
          isOpen: true,
          title: 'Hata',
          message: `Ünite güncellenirken bir hata oluştu: ${e.message}`,
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      }
    };

    const handleDeleteUnit = (unitId) => {
      setModal({
        isOpen: true,
        title: 'Ünite Sil',
        message: 'Bu üniteyi ve tüm sorularını silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.',
        showConfirmButton: true,
        onConfirm: async () => {
          try {
            // Üniteye ait tüm soruları sil
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/units/${unitId}/questions`));
            const querySnapshot = await getDocs(q);
            const deletePromises = querySnapshot.docs.map(d => deleteDoc(d.ref));
            await Promise.all(deletePromises);

            // Üniteyi sil
            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/units`, unitId));
            setModal({ ...modal, isOpen: false }); // Modalı kapat
            setModal({
              isOpen: true,
              title: 'Başarılı',
              message: 'Ünite ve ilgili sorular başarıyla silindi.',
              onClose: () => setModal({ ...modal, isOpen: false }),
            });
            if (selectedUnitForQuestions && selectedUnitForQuestions.id === unitId) {
              setSelectedUnitForQuestions(null); // Seçili ünite silindiyse sıfırla
            }
          } catch (e) {
            console.error("Ünite silerken hata:", e);
            setModal({
              isOpen: true,
              title: 'Hata',
              message: `Ünite silinirken bir hata oluştu: ${e.message}`,
              onClose: () => setModal({ ...modal, isOpen: false }),
            });
          }
        },
        onClose: () => setModal({ ...modal, isOpen: false }),
      });
    };

    // Soru Ekle/Düzenle Fonksiyonları
    const resetQuestionForm = () => {
      setQuestionText('');
      setOptionA('');
      setOptionB('');
      setOptionC('');
      setOptionD('');
      setCorrectAnswer('');
      setDifficulty('Normal');
      setQuestionPoints(10);
      setCurrentQuestion(null);
      setShowAddQuestionForm(false);
    };

    const handleAddOrUpdateQuestion = async () => {
      if (!selectedUnitForQuestions) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Lütfen önce bir ünite seçin.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      if (!questionText.trim() || !optionA.trim() || !optionB.trim() || !optionC.trim() || !optionD.trim() || !correctAnswer.trim()) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Lütfen tüm soru alanlarını doldurun.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      if (!['A', 'B', 'C', 'D'].includes(correctAnswer.toUpperCase())) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Doğru cevap A, B, C veya D olmalıdır.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }

      const questionData = {
        text: questionText.trim(),
        options: { A: optionA.trim(), B: optionB.trim(), C: optionC.trim(), D: optionD.trim() },
        correctAnswer: correctAnswer.toUpperCase(),
        difficulty: difficulty,
        points: Number(questionPoints),
        createdAt: new Date(),
        unitId: selectedUnitForQuestions.id,
        // Tekil soru eklemede sınıf ve ders üniteye bağlı olduğu için ayrıca eklemeye gerek yok
        // grade: selectedUnitForQuestions.grade,
        // subject: selectedUnitForQuestions.subject,
      };

      try {
        if (currentQuestion) {
          // Soru düzenleniyor
          await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/units/${selectedUnitForQuestions.id}/questions`, currentQuestion.id), questionData);
          setModal({
            isOpen: true,
            title: 'Başarılı',
            message: 'Soru başarıyla güncellendi.',
            onClose: () => setModal({ ...modal, isOpen: false }),
          });
        } else {
          // Yeni soru ekleniyor
          await addDoc(collection(db, `artifacts/${appId}/users/${userId}/units/${selectedUnitForQuestions.id}/questions`), questionData);
          setModal({
            isOpen: true,
            title: 'Başarılı',
            message: 'Soru başarıyla eklendi.',
            onClose: () => setModal({ ...modal, isOpen: false }),
          });
        }
        resetQuestionForm();
      } catch (e) {
        console.error("Soru eklerken/güncellerken hata:", e);
        setModal({
          isOpen: true,
          title: 'Hata',
          message: `Soru eklenirken/güncellenirken bir hata oluştu: ${e.message}`,
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      }
    };

    const handleEditQuestionClick = (question) => {
      setCurrentQuestion(question);
      setQuestionText(question.text);
      setOptionA(question.options.A);
      setOptionB(question.options.B);
      setOptionC(question.options.C);
      setOptionD(question.options.D);
      setCorrectAnswer(question.correctAnswer);
      setDifficulty(question.difficulty);
      setQuestionPoints(question.points);
      setShowAddQuestionForm(true);
    };

    const handleDeleteQuestion = (questionId) => {
      setModal({
        isOpen: true,
        title: 'Soru Sil',
        message: 'Bu soruyu silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.',
        showConfirmButton: true,
        onConfirm: async () => {
          try {
            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/units/${selectedUnitForQuestions.id}/questions`, questionId));
            setModal({ ...modal, isOpen: false });
            setModal({
              isOpen: true,
              title: 'Başarılı',
              message: 'Soru başarıyla silindi.',
              onClose: () => setModal({ ...modal, isOpen: false }),
            });
          } catch (e) {
            console.error("Soru silerken hata:", e);
            setModal({
              isOpen: true,
              title: 'Hata',
              message: `Soru silinirken bir hata oluştu: ${e.message}`,
              onClose: () => setModal({ ...modal, isOpen: false }),
            });
          }
        },
        onClose: () => setModal({ ...modal, isOpen: false }),
      });
    };

    // Toplu Soru Yükleme (CSV) Fonksiyonları
    const handleCsvFileChange = (e) => {
      setBulkFile(e.target.files[0]);
      setBulkPreview([]);
      setBulkErrors([]);
    };

    const handleDownloadTemplate = () => {
      // Güncellenmiş başlıklar ve örnek - Sınıf, Ders, Zorluk, Puan kaldırıldı
      const headers = "SoruMetni,SecenekA,SecenekB,SecenekC,SecenekD,DogruCevap\n";
      const example = "Türkiye'nin başkenti neresidir?,Ankara,İstanbul,İzmir,Bursa,A\n";
      const blob = new Blob([headers, example], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'soru_sablonu.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    };

    const handleUploadBulkCsvQuestions = () => {
      if (!bulkFile) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Lütfen yüklenecek bir dosya seçin.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      if (!selectedUnitForBulkUpload) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Lütfen soruları yüklemek için bir ünite seçin.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      if (!selectedBulkGrade || !selectedBulkSubject || !selectedBulkDifficulty || !selectedBulkPoints) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Lütfen toplu yükleme için Sınıf, Ders, Zorluk Seviyesi ve Puan seçin.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }


      const reader = new FileReader();
      reader.onload = async (e) => {
        const text = e.target.result;
        const lines = text.split('\n').filter(line => line.trim() !== '');
        const headers = lines[0].split(',').map(h => h.trim()); // Yeni başlıklar
        const expectedHeaders = ["SoruMetni", "SecenekA", "SecenekB", "SecenekC", "SecenekD", "DogruCevap"]; // Puan kaldırıldı

        if (headers.length !== expectedHeaders.length || !expectedHeaders.every(h => headers.includes(h))) {
            setModal({
                isOpen: true,
                title: 'Hata',
                message: `CSV başlıkları yanlış. Beklenen: ${expectedHeaders.join(', ')}`,
                onClose: () => setModal({ ...modal, isOpen: false }),
            });
            return;
        }

        const questionsToProcess = [];
        const errors = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',').map(v => v.trim());
          if (values.length !== expectedHeaders.length) { // Sadece beklenen başlık sayısı kadar sütun kontrolü
            errors.push(`Satır ${i + 1}: Eksik veya fazla sütun.`);
            continue;
          }

          const question = {};
          expectedHeaders.forEach((header, index) => {
            question[header] = values[index];
          });

          // Doğrulama
          if (!question.SoruMetni || !question.SecenekA || !question.SecenekB || !question.SecenekC || !question.SecenekD || !question.DogruCevap) { // Puan kaldırıldı
            errors.push(`Satır ${i + 1}: Eksik alanlar. Tüm temel alanlar (SoruMetni, SeçenekA, SeçenekB, SeçenekC, SeçenekD, DoğruCevap) dolu olmalı.`);
            continue;
          }
          if (!['A', 'B', 'C', 'D'].includes(question.DogruCevap.toUpperCase())) {
            errors.push(`Satır ${i + 1}: Geçersiz DoğruCevap (${question.DogruCevap}). A, B, C veya D olmalı.`);
            continue;
          }
          // Puan doğrulama kaldırıldı

          questionsToProcess.push({
            text: question.SoruMetni,
            options: { A: question.SecenekA, B: question.SecenekB, C: question.SecenekC, D: question.SecenekD },
            correctAnswer: question.DogruCevap.toUpperCase(),
            points: Number(selectedBulkPoints), // UI'dan alınan değer
            difficulty: selectedBulkDifficulty, // UI'dan alınan değer
            grade: selectedBulkGrade, // UI'dan alınan değer
            subject: selectedBulkSubject, // UI'dan alınan değer
            unitId: selectedUnitForBulkUpload.id,
            createdAt: new Date(),
          });
        }
        setBulkPreview(questionsToProcess);
        setBulkErrors(errors);

        // Önizleme modalını aç
        setShowBulkPreviewModal(true);
      };
      reader.readAsText(bulkFile);
    };

    const handleConfirmBulkSave = async () => {
      if (bulkPreview.length === 0) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Kaydedilecek soru bulunamadı.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      if (!selectedUnitForBulkUpload) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Lütfen soruları kaydetmek için bir ünite seçin.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }

      try {
        const batch = [];
        bulkPreview.forEach(q => {
          batch.push(addDoc(collection(db, `artifacts/${appId}/users/${userId}/units/${selectedUnitForBulkUpload.id}/questions`), q));
        });
        await Promise.all(batch);
        setModal({
          isOpen: true,
          title: 'Başarılı',
          message: `${bulkPreview.length} adet soru başarıyla eklendi.`,
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        // Başarılı kayıttan sonra state'leri sıfırla ve modalı kapat
        setBulkFile(null);
        setBulkPreview([]);
        setBulkErrors([]);
        setShowBulkPreviewModal(false);
      } catch (e) {
        console.error("Toplu soru kaydederken hata:", e);
        setModal({
          isOpen: true,
          title: 'Hata',
          message: `Toplu soru kaydederken bir hata oluştu: ${e.message}`,
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      }
    };

    const handleCancelBulkPreview = () => {
      setBulkFile(null);
      setBulkPreview([]);
      setBulkErrors([]);
      setShowBulkPreviewModal(false);
    };


    const handleDownloadQuestions = () => {
        let questionsToDownload = [];
        let fileName = 'tum_sorular.csv';

        // Tüm soruları al
        let filteredQuestions = Object.values(questionsByUnit).flat();

        // Filtreleme mantığı
        if (selectedDownloadUnit) {
            filteredQuestions = filteredQuestions.filter(q => q.unitId === selectedDownloadUnit);
            fileName = `${units.find(u => u.id === selectedDownloadUnit)?.name || 'secili_unite'}_sorulari.csv`;
        } else {
            if (selectedDownloadGrade) {
                filteredQuestions = filteredQuestions.filter(q => q.grade === selectedDownloadGrade);
            }
            if (selectedDownloadSubject) {
                filteredQuestions = filteredQuestions.filter(q => q.subject === selectedDownloadSubject);
            }
            if (selectedDownloadGrade && selectedDownloadSubject) {
                fileName = `${selectedDownloadGrade}_${selectedDownloadSubject}_sorulari.csv`;
            } else if (selectedDownloadGrade) {
                fileName = `${selectedDownloadGrade}_sorulari.csv`;
            } else if (selectedDownloadSubject) {
                fileName = `${selectedDownloadSubject}_sorulari.csv`;
            } else {
                fileName = 'tum_sorular.csv';
            }
        }

        questionsToDownload = filteredQuestions;


        if (questionsToDownload.length === 0) {
            setModal({
                isOpen: true,
                title: 'Uyarı',
                message: 'İndirilecek soru bulunamadı.',
                onClose: () => setModal({ ...modal, isOpen: false }),
            });
            return;
        }

        // Headers for download - simplified (Puan kaldırıldı)
        const headers = "SoruMetni,SecenekA,SecenekB,SecenekC,SecenekD,DogruCevap\n";
        const csvContent = questionsToDownload.map(q => {
            const row = [
                `"${q.text.replace(/"/g, '""')}"`, // Escape double quotes
                `"${q.options.A.replace(/"/g, '""')}"`,
                `"${q.options.B.replace(/"/g, '""')}"`,
                `"${q.options.C.replace(/"/g, '""')}"`,
                `"${q.options.D.replace(/"/g, '""')}"`,
                q.correctAnswer
                // Puan, Sınıf, Ders, Zorluk artık indirme şablonunda yok
            ];
            return row.join(',');
        }).join('\n');

        const fullCsv = headers + csvContent;
        const blob = new Blob([fullCsv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    };


    return (
      <div className="flex flex-col items-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-4">
        <h1 className="text-3xl font-bold text-gray-800 mb-6 mt-4 break-words">Soru Kaynağı ve Yönetimi</h1>
        <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl space-y-8">

          {/* Ünite Yönetimi */}
          <div className="p-4 border border-gray-200 rounded-lg bg-gray-50">
            <h4 className="text-xl font-semibold text-gray-700 mb-3 break-words">Ünite Yönetimi</h4>
            <div className="flex flex-col sm:flex-row gap-2 mb-4">
              <input
                type="text"
                placeholder="Yeni Ünite Adı"
                value={newUnitName}
                onChange={(e) => setNewUnitName(e.target.value)}
                className="flex-grow p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
              />
              <select
                value={newUnitGrade}
                onChange={(e) => setNewUnitGrade(e.target.value)}
                className="p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
              >
                <option value="">Sınıf Seçin</option>
                <option value="5">5. Sınıf</option>
                <option value="6">6. Sınıf</option>
                <option value="7">7. Sınıf</option>
                <option value="8">8. Sınıf</option>
              </select>
              <select
                value={newUnitSubject}
                onChange={(e) => setNewUnitSubject(e.target.value)}
                className="p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
              >
                <option value="">Ders Seçin</option>
                <option value="Din Kültürü ve Ahlak Bilgisi">Din Kültürü ve Ahlak Bilgisi</option>
                <option value="Peygamberimizin Hayatı">Peygamberimizin Hayatı</option>
              </select>
              <button
                onClick={handleAddUnit}
                className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors font-semibold"
              >
                Ünite Ekle
              </button>
            </div>

            {units.length === 0 ? (
              <p className="text-gray-600 break-words">Henüz ünite yok.</p>
            ) : (
              <ul className="space-y-2 max-h-40 overflow-y-auto pr-2">
                {units.map((unit) => (
                  <li key={unit.id} className="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm">
                    {editingUnit && editingUnit.id === unit.id ? (
                      <div className="flex-grow flex gap-2">
                        <input
                          type="text"
                          value={editUnitName}
                          onChange={(e) => setEditUnitName(e.target.value)}
                          className="flex-grow p-1 border border-gray-300 rounded-md text-sm"
                        />
                        <select
                          value={editUnitGrade}
                          onChange={(e) => setEditUnitGrade(e.target.value)}
                          className="p-1 border border-gray-300 rounded-md text-sm"
                        >
                          <option value="">Sınıf Seçin</option>
                          <option value="5">5. Sınıf</option>
                          <option value="6">6. Sınıf</option>
                          <option value="7">7. Sınıf</option>
                          <option value="8">8. Sınıf</option>
                        </select>
                        <select
                          value={editUnitSubject}
                          onChange={(e) => setEditUnitSubject(e.target.value)}
                          className="p-1 border border-gray-300 rounded-md text-sm"
                        >
                          <option value="">Ders Seçin</option>
                          <option value="Din Kültürü ve Ahlak Bilgisi">Din Kültürü ve Ahlak Bilgisi</option>
                          <option value="Peygamberimizin Hayatı">Peygamberimizin Hayatı</option>
                        </select>
                        <button
                          onClick={handleSaveUnitEdit}
                          className="bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600 text-sm"
                        >
                          Kaydet
                        </button>
                        <button
                          onClick={() => setEditingUnit(null)}
                          className="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400 text-sm"
                        >
                          İptal
                        </button>
                      </div>
                    ) : (
                      <>
                        <span className="text-gray-800 font-medium break-words">{unit.name}</span>
                        <span className="text-gray-600 text-sm ml-2 break-words">({unit.grade}. Sınıf - {unit.subject})</span>
                        <div className="flex space-x-2">
                          <button
                            onClick={() => handleEditUnitClick(unit)}
                            className="bg-yellow-500 text-white px-3 py-1 rounded-md hover:bg-yellow-600 transition-colors text-sm"
                          >
                            Düzenle
                          </button>
                          <button
                            onClick={() => handleDeleteUnit(unit.id)}
                            className="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition-colors text-sm"
                          >
                            Sil
                          </button>
                        </div>
                      </>
                    )}
                  </li>
                ))}
              </ul>
            )}
          </div>

          {/* Ünite Seçimi ve Soru Listesi (Tek Tek Ekleme/Düzenleme) */}
          <div className="p-4 border border-gray-200 rounded-lg bg-gray-50">
            <h4 className="text-xl font-semibold text-gray-700 mb-3 break-words">Soruları Yönet (Tek Tek)</h4>
            <select
              className="w-full p-2 border border-gray-300 rounded-md mb-4 focus:ring-1 focus:ring-blue-500"
              onChange={(e) => setSelectedUnitForQuestions(units.find(u => u.id === e.target.value))}
              value={selectedUnitForQuestions ? selectedUnitForQuestions.id : ''}
            >
              <option value="">Ünite Seçin</option>
              {units.map(unit => (
                <option key={unit.id} value={unit.id}>{unit.name} ({unit.grade}. Sınıf - {unit.subject})</option>
              ))}
            </select>

            {selectedUnitForQuestions && (
              <>
                <h5 className="text-lg font-semibold text-gray-800 mb-3 break-words">
                  {selectedUnitForQuestions.name} Ünitesindeki Sorular ({questionsByUnit[selectedUnitForQuestions.id]?.length || 0} adet)
                </h5>
                <button
                  onClick={() => setShowAddQuestionForm(true)}
                  className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors font-semibold mb-4"
                >
                  Yeni Soru Ekle
                </button>
                {(questionsByUnit[selectedUnitForQuestions.id]?.length || 0) === 0 ? (
                  <p className="text-gray-600 break-words">Bu ünitede henüz soru yok.</p>
                ) : (
                  <ul className="space-y-2 max-h-60 overflow-y-auto pr-2">
                    {questionsByUnit[selectedUnitForQuestions.id]?.map((q) => (
                      <li key={q.id} className="bg-white p-3 rounded-lg shadow-sm flex flex-col sm:flex-row items-start sm:items-center justify-between">
                        <div className="flex-grow mb-2 sm:mb-0">
                          <p className="text-gray-800 font-medium text-sm break-words">{q.text}</p>
                          <p className="text-gray-600 text-xs break-words">Doğru: {q.correctAnswer} | Puan: {q.points} | Zorluk: {q.difficulty}</p>
                          <p className="text-gray-600 text-xs break-words">{selectedUnitForQuestions.grade}. Sınıf - {selectedUnitForQuestions.subject}</p>
                        </div>
                        <div className="flex space-x-2">
                          <button
                            onClick={() => handleEditQuestionClick(q)}
                            className="bg-yellow-500 text-white px-3 py-1 rounded-md hover:bg-yellow-600 text-xs"
                          >
                            Düzenle
                          </button>
                          <button
                            onClick={() => handleDeleteQuestion(q.id)}
                            className="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 text-xs"
                          >
                            Sil
                          </button>
                        </div>
                      </li>
                    ))}
                  </ul>
                )}
              </>
            )}
          </div>

          {/* Soru Ekleme/Düzenleme Formu */}
          {showAddQuestionForm && (
            <div className="p-4 border border-gray-200 rounded-lg bg-gray-50">
              <h4 className="text-xl font-semibold text-gray-700 mb-3 break-words">{currentQuestion ? 'Soruyu Düzenle' : 'Yeni Soru Ekle'}</h4>
              <div className="space-y-3">
                <textarea
                  placeholder="Soru Metni"
                  value={questionText}
                  onChange={(e) => setQuestionText(e.target.value)}
                  className="w-full p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 h-24"
                ></textarea>
                {['A', 'B', 'C', 'D'].map((char) => (
                  <input
                    key={char}
                    type="text"
                    placeholder={`Seçenek ${char}`}
                    value={getOptionValue(char)}
                    onChange={(e) => setOptionValue(char, e.target.value)}
                    className="w-full p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
                  />
                ))}
                <div className="flex items-center space-x-4">
                  <label className="text-gray-700 font-medium break-words">Doğru Cevap:</label>
                  <select
                    value={correctAnswer}
                    onChange={(e) => setCorrectAnswer(e.target.value)}
                    className="p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
                  >
                    <option value="">Seçiniz</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                  </select>
                </div>
                <div className="flex items-center space-x-4">
                  <label className="text-gray-700 font-medium break-words">Zorluk Seviyesi:</label>
                  <select
                    value={difficulty}
                    onChange={(e) => setDifficulty(e.target.value)}
                    className="p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
                  >
                    <option value="Kolay">Kolay</option>
                    <option value="Normal">Normal</option>
                    <option value="Zor">Zor</option>
                  </select>
                </div>
                <div className="flex items-center space-x-4">
                  <label className="text-gray-700 font-medium break-words">Puan:</label>
                  <input
                    type="number"
                    value={questionPoints}
                    onChange={(e) => setQuestionPoints(Number(e.target.value))}
                    className="p-2 border border-gray-300 rounded-md w-24 focus:ring-1 focus:ring-blue-500"
                    min="1"
                  />
                </div>
                <div className="flex space-x-2 justify-end">
                  <button
                    onClick={handleAddOrUpdateQuestion}
                    className="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors font-semibold"
                  >
                    {currentQuestion ? 'Güncelle' : 'Ekle'}
                  </button>
                  <button
                    onClick={resetQuestionForm}
                    className="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors font-semibold"
                  >
                    İptal
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Toplu Soru Yükleme (CSV) */}
          <div className="p-4 border border-gray-200 rounded-lg bg-gray-50">
            <h4 className="text-xl font-semibold text-gray-700 mb-3 break-words">Toplu Soru Yükleme ve İndirme (CSV)</h4>
            <p className="text-gray-600 text-sm mb-3 break-words">
              Sorularınızı CSV formatında yükleyebilir veya mevcut sorularınızı indirebilirsiniz. Eğer Excel kullanıyorsanız, lütfen dosyanızı "Farklı Kaydet" seçeneği ile "CSV (Virgülle Ayrılmış)" olarak kaydedip yükleyiniz.
            </p>
            <div className="flex flex-wrap gap-3 mb-4">
                <button
                  onClick={handleDownloadTemplate}
                  className="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors font-semibold flex-grow sm:flex-grow-0"
                >
                  Şablonu İndir
                </button>
                <button
                    onClick={handleDownloadQuestions}
                    className="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors font-semibold flex-grow sm:flex-grow-0"
                    disabled={units.length === 0 && Object.values(questionsByUnit).flat().length === 0} // Hiç ünite veya soru yoksa devre dışı bırak
                >
                    Toplu Soruları İndir
                </button>
            </div>

            {/* Toplu Yükleme Bölümü */}
            <div className="mb-6 p-4 border border-gray-200 rounded-lg bg-white">
                <h5 className="text-lg font-semibold text-gray-800 mb-3 break-words">Toplu Yükleme Ayarları</h5>
                <div className="mb-4">
                    <label htmlFor="unitSelectBulk" className="block text-gray-700 text-sm font-bold mb-2 break-words">
                        Soruları Yüklenecek Üniteyi Seçin:
                    </label>
                    <select
                        id="unitSelectBulk"
                        className="w-full p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
                        onChange={(e) => setSelectedUnitForBulkUpload(units.find(u => u.id === e.target.value))}
                        value={selectedUnitForBulkUpload ? selectedUnitForBulkUpload.id : ''}
                    >
                        <option value="">Ünite Seçin</option>
                        {units.map(unit => (
                            <option key={unit.id} value={unit.id}>{unit.name} ({unit.grade}. Sınıf - {unit.subject})</option>
                        ))}
                    </select>
                </div>

                <div className="flex flex-col sm:flex-row gap-3 mb-4">
                    <select
                        value={selectedBulkGrade}
                        onChange={(e) => setSelectedBulkGrade(e.target.value)}
                        className="flex-grow p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
                    >
                        <option value="">Sınıf Seçin (Toplu Yükleme)</option>
                        <option value="5">5. Sınıf</option>
                        <option value="6">6. Sınıf</option>
                        <option value="7">7. Sınıf</option>
                        <option value="8">8. Sınıf</option>
                    </select>
                    <select
                        value={selectedBulkSubject}
                        onChange={(e) => setSelectedBulkSubject(e.target.value)}
                        className="flex-grow p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
                    >
                        <option value="">Ders Seçin (Toplu Yükleme)</option>
                        <option value="Din Kültürü ve Ahlak Bilgisi">Din Kültürü ve Ahlak Bilgisi</option>
                        <option value="Peygamberimizin Hayatı">Peygamberimizin Hayatı</option>
                    </select>
                    <select
                        value={selectedBulkDifficulty}
                        onChange={(e) => setSelectedBulkDifficulty(e.target.value)}
                        className="flex-grow p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
                    >
                        <option value="">Zorluk Seçin (Toplu Yükleme)</option>
                        <option value="Kolay">Kolay</option>
                        <option value="Normal">Normal</option>
                        <option value="Zor">Zor</option>
                    </select>
                    <input
                        type="number"
                        placeholder="Puan (Toplu Yükleme)"
                        value={selectedBulkPoints}
                        onChange={(e) => setSelectedBulkPoints(Number(e.target.value))}
                        className="flex-grow p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
                        min="1"
                    />
                </div>

                <div className="flex flex-col sm:flex-row items-center gap-3">
                    <input
                        type="file"
                        accept=".csv"
                        onChange={handleCsvFileChange}
                        className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"
                    />
                    <button
                        onClick={handleUploadBulkCsvQuestions}
                        className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors font-semibold w-full sm:w-auto"
                    >
                        CSV Dosyasını Yükle
                    </button>
                </div>
            </div>

            {/* Toplu İndirme Filtreleri */}
            <div className="mb-4 p-4 border border-gray-200 rounded-lg bg-white">
                <h5 className="text-lg font-semibold text-gray-800 mb-3 break-words">Toplu İndirme Filtreleri</h5>
                <div className="flex flex-col sm:flex-row gap-3 mb-4">
                    <select
                        value={selectedDownloadGrade}
                        onChange={(e) => {
                            setSelectedDownloadGrade(e.target.value);
                            setSelectedDownloadUnit(''); // Sınıf değişince ünite seçimini sıfırla
                        }}
                        className="flex-grow p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
                    >
                        <option value="">Sınıf Seçin (İndirme)</option>
                        <option value="5">5. Sınıf</option>
                        <option value="6">6. Sınıf</option>
                        <option value="7">7. Sınıf</option>
                        <option value="8">8. Sınıf</option>
                    </select>
                    <select
                        value={selectedDownloadSubject}
                        onChange={(e) => {
                            setSelectedDownloadSubject(e.target.value);
                            setSelectedDownloadUnit(''); // Ders değişince ünite seçimini sıfırla
                        }}
                        className="flex-grow p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
                    >
                        <option value="">Ders Seçin (İndirme)</option>
                        <option value="Din Kültürü ve Ahlak Bilgisi">Din Kültürü ve Ahlak Bilgisi</option>
                        <option value="Peygamberimizin Hayatı">Peygamberimizin Hayatı</option>
                    </select>
                    <select
                        value={selectedDownloadUnit}
                        onChange={(e) => setSelectedDownloadUnit(e.target.value)}
                        className="flex-grow p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
                        disabled={!selectedDownloadGrade && !selectedDownloadSubject} // Sınıf veya ders seçilmeden ünite seçimi pasif
                    >
                        <option value="">Ünite Seçin (İndirme)</option>
                        {units
                            .filter(unit =>
                                (!selectedDownloadGrade || unit.grade === selectedDownloadGrade) &&
                                (!selectedDownloadSubject || unit.subject === selectedDownloadSubject)
                            )
                            .map(unit => (
                                <option key={unit.id} value={unit.id}>{unit.name}</option>
                            ))}
                    </select>
                </div>
            </div>
          </div>

          {/* Tüm Soruların Listesi */}
          <div className="p-4 border border-gray-200 rounded-lg bg-gray-50">
            <h4 className="text-xl font-semibold text-gray-700 mb-3 break-words">Tüm Sorularınız ({allQuestions.length} adet)</h4>
            {allQuestions.length === 0 ? (
              <p className="text-gray-600 break-words">Henüz hiç soru eklenmemiş.</p>
            ) : (
              <ul className="space-y-2 max-h-80 overflow-y-auto pr-2">
                {allQuestions.map((q) => (
                  <li key={q.id} className="bg-white p-3 rounded-lg shadow-sm">
                    <p className="text-gray-800 font-medium text-sm break-words">{q.text}</p>
                    <p className="text-gray-600 text-xs break-words">
                      Ünite: {units.find(u => u.id === q.unitId)?.name || 'Bilinmiyor'} | Doğru: {q.correctAnswer} | Puan: {q.points} | Zorluk: {q.difficulty}
                    </p>
                    <p className="text-gray-600 text-xs break-words">Sınıf: {q.grade} | Ders: {q.subject}</p>
                  </li>
                ))}
              </ul>
            )}
          </div>

          <button
            onClick={() => setCurrentView('tools')}
            className="w-full mt-6 bg-gray-500 text-white py-3 rounded-md hover:bg-gray-600 transition-colors font-semibold"
          >
            Geri
          </button>
        </div>

        {/* Bulk Preview Modal */}
        <BulkQuestionPreviewModal
          isOpen={showBulkPreviewModal}
          onClose={handleCancelBulkPreview} // Modalı kapatma ve iptal etme aynı işlevi görebilir
          questions={bulkPreview}
          errors={bulkErrors}
          onConfirmSave={handleConfirmBulkSave}
          onCancel={handleCancelBulkPreview}
        />
      </div>
    );
  };


  // Uygulama Yükleniyor Durumu
  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200">
        <div className="text-blue-700 text-2xl font-semibold">Yükleniyor...</div>
      </div>
    );
  }

  // Ana Uygulama Render'ı
  return (
    <FirebaseContext.Provider value={{ db, auth, userId, appId }}>
      <div className="font-inter antialiased">
        {currentView === 'main' && <MainScreen />}
        {currentView === 'studentSelection' && <StudentSelection initialMode={initialStudentViewMode} />}
        {currentView === 'settings' && <Settings db={db} userId={userId} appSettings={appSettings} students={students} units={units} questions={questions} setModal={setModal} modal={modal} handleUpdateSetting={handleUpdateSetting} setCurrentView={setCurrentView} questionsByUnit={questionsByUnit} />}
        {currentView === 'unitSelection' && <UnitSelectionScreen setUnitToManageId={setUnitToManageId} />}
        {/* QuizPlayScreen kaldırıldı */}
        {currentView === 'tools' && <ToolsScreen />}
        {currentView === 'studentManagement' && <StudentManagement db={db} userId={userId} students={students} setModal={setModal} modal={modal} setCurrentView={setCurrentView} />}
        {currentView === 'questionSource' && <QuestionSourceScreen db={db} userId={userId} units={units} questionsByUnit={questionsByUnit} setModal={setModal} modal={modal} setCurrentView={setCurrentView} unitToManageId={unitToManageId} />}


        <Modal
          isOpen={modal.isOpen}
          onClose={modal.onClose}
          title={modal.title}
          message={modal.message}
          onConfirm={modal.onConfirm}
          showConfirmButton={modal.showConfirmButton}
        />
      </div>
    </FirebaseContext.Provider>
  );
}
