import React, { useState, useEffect, createContext, useContext, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, addDoc, deleteDoc, getDocs } from 'firebase/firestore';

// Firebase yapılandırması ve global değişkenler
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-quiz-app';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Firebase Context'i oluşturma
const FirebaseContext = createContext(null);

// Modal bileşeni (alert ve confirm yerine kullanılacak)
const Modal = ({ isOpen, onClose, title, message, onConfirm, showConfirmButton = false }) => {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-auto">
        <h3 className="text-xl font-semibold text-gray-900 mb-4">{title}</h3>
        <p className="text-gray-700 mb-6">{message}</p>
        <div className="flex justify-end space-x-3">
          {showConfirmButton && (
            <button
              onClick={onConfirm}
              className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors"
            >
              Onayla
            </button>
          )}
          <button
            onClick={onClose}
            className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
          >
            Kapat
          </button>
        </div>
      </div>
    </div>
  );
};

// Ana uygulama bileşeni
export default function App() {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [loading, setLoading] = useState(true);
  const [currentView, setCurrentView] = useState('main'); // main, settings, unitSelection, quizPlay, studentManagement, questionManagement, tools
  const [selectedStudent, setSelectedStudent] = useState(null);
  const [selectedUnit, setSelectedUnit] = useState(null);
  const [appSettings, setAppSettings] = useState(null); // Uygulama ayarları
  const [students, setStudents] = useState([]); // Öğrenci listesi
  const [units, setUnits] = useState([]); // Ünite listesi
  const [questions, setQuestions] = useState([]); // Seçili üniteye ait sorular
  const [initialStudentViewMode, setInitialStudentViewMode] = useState('select'); // 'select' or 'register' mode for StudentSelection

  // Modal durumu
  const [modal, setModal] = useState({ isOpen: false, title: '', message: '', onConfirm: null, showConfirmButton: false });

  // Firebase başlatma ve kimlik doğrulama
  useEffect(() => {
    const initializeFirebase = async () => {
      try {
        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const authInstance = getAuth(app);

        setDb(firestore);
        setAuth(authInstance);

        // Kimlik doğrulama durumu değiştiğinde dinleyici
        const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
          if (user) {
            setUserId(user.uid);
          } else {
            // Kullanıcı yoksa anonim olarak oturum aç
            if (initialAuthToken) {
              await signInWithCustomToken(authInstance, initialAuthToken);
            } else {
              await signInAnonymously(authInstance);
            }
          }
          setLoading(false);
        });

        return () => unsubscribe();
      } catch (error) {
        console.error("Firebase başlatma hatası:", error);
        setModal({
          isOpen: true,
          title: 'Hata',
          message: `Uygulama başlatılamadı: ${error.message}`,
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        setLoading(false);
      }
    };

    initializeFirebase();
  }, []);

  // Kullanıcı ID'si değiştiğinde veya db/auth hazır olduğunda ayarları ve öğrenci/ünite/soru listelerini dinle
  useEffect(() => {
    if (!db || !userId) return;

    // Ayarları dinle
    const settingsDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/appSettings`);
    const unsubscribeSettings = onSnapshot(settingsDocRef, (docSnap) => {
      if (docSnap.exists()) {
        setAppSettings(docSnap.data());
      } else {
        // Varsayılan ayarları kaydet
        const defaultSettings = {
          timePerQuestion: 30, // Soru başına varsayılan süre
          enableNegativeScoring: false, // Yanlış cevapta puan eksiltme
          enableFastAnswerBonus: false, // Hızlı cevap bonusu
          fastAnswerBonusTime: 5, // Bonus için maksimum süre
          fastAnswerBonusPoints: 10, // Bonus puan miktarı
          showAnswerOnWrong: true, // Yanlış cevapta doğru cevabı göster
        };
        setDoc(settingsDocRef, defaultSettings).catch(e => console.error("Varsayılan ayarları kaydederken hata:", e));
        setAppSettings(defaultSettings);
      }
    }, (error) => console.error("Ayarları dinlerken hata:", error));

    // Öğrencileri dinle (kullanıcıya özel)
    const studentsColRef = collection(db, `artifacts/${appId}/users/${userId}/students`);
    const unsubscribeStudents = onSnapshot(studentsColRef, (snapshot) => {
      const studentList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setStudents(studentList);
    }, (error) => console.error("Öğrencileri dinlerken hata:", error));

    // Üniteleri dinle (kullanıcıya özel)
    const unitsColRef = collection(db, `artifacts/${appId}/users/${userId}/units`);
    const unsubscribeUnits = onSnapshot(unitsColRef, (snapshot) => {
      const unitList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setUnits(unitList);
    }, (error) => console.error("Üniteleri dinlerken hata:", error));

    return () => {
      unsubscribeSettings();
      unsubscribeStudents();
      unsubscribeUnits();
    };
  }, [db, userId]);

  // Seçili ünite değiştiğinde soruları dinle
  useEffect(() => {
    if (!db || !userId || !selectedUnit) {
      setQuestions([]); // Seçili ünite yoksa soruları temizle
      return;
    }

    const questionsColRef = collection(db, `artifacts/${appId}/users/${userId}/units/${selectedUnit.id}/questions`);
    const unsubscribeQuestions = onSnapshot(questionsColRef, (snapshot) => {
      const questionList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Soruları manuel olarak sırala (Firestore orderBy kullanmaktan kaçınmak için)
      questionList.sort((a, b) => a.questionNumber - b.questionNumber);
      setQuestions(questionList);
    }, (error) => console.error("Soruları dinlerken hata:", error));

    return () => unsubscribeQuestions();
  }, [db, userId, selectedUnit]);

  // Ayarları güncelleme fonksiyonu (App bileşeni içinde tanımlandı)
  const handleUpdateSetting = async (key, value) => {
    if (!db || !userId) return;
    try {
      const settingsDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/appSettings`);
      await updateDoc(settingsDocRef, { [key]: value });
      setModal({
        isOpen: true,
        title: 'Başarılı',
        message: 'Ayar başarıyla güncellendi.',
        onClose: () => setModal({ ...modal, isOpen: false }),
      });
    } catch (e) {
      console.error("Ayar güncellerken hata:", e);
      setModal({
        isOpen: true,
        title: 'Hata',
        message: `Ayar güncellenirken bir hata oluştu: ${e.message}`,
        onClose: () => setModal({ ...modal, isOpen: false }),
      });
    }
  };

  // Uygulamayı sıfırlama fonksiyonu
  const handleResetApplication = async () => {
    if (!db || !userId) return;

    setModal({
      isOpen: true,
      title: 'Uygulamayı Sıfırla',
      message: 'Tüm öğrenci, ünite ve soru verileri silinecek. Bu işlem geri alınamaz. Emin misiniz?',
      showConfirmButton: true,
      onConfirm: async () => {
        try {
          // Öğrenci verilerini sil
          const studentsColRef = collection(db, `artifacts/${appId}/users/${userId}/students`);
          const studentDocs = await getDocs(studentsColRef);
          const studentDeletePromises = studentDocs.docs.map(d => deleteDoc(d.ref));
          await Promise.all(studentDeletePromises);

          // Ünite ve soruları sil
          const unitsColRef = collection(db, `artifacts/${appId}/users/${userId}/units`);
          const unitDocs = await getDocs(unitsColRef);
          for (const unitDoc of unitDocs.docs) {
            const questionsColRef = collection(db, `artifacts/${appId}/users/${userId}/units/${unitDoc.id}/questions`);
            const questionDocs = await getDocs(questionsColRef);
            const questionDeletePromises = questionDocs.docs.map(d => deleteDoc(d.ref));
            await Promise.all(questionDeletePromises);
            await deleteDoc(unitDoc.ref); // Üniteyi sil
          }

          // Ayarları sil
          const settingsDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/appSettings`);
          await deleteDoc(settingsDocRef);

          // Liderlik tablosundaki kullanıcı verisini sil (isteğe bağlı, genel liderlik tablosu)
          const leaderboardDocRef = doc(db, `artifacts/${appId}/public/data/leaderboard`, userId);
            const leaderboardDocSnap = await getDoc(leaderboardDocRef);
            if (leaderboardDocSnap.exists()) {
                await deleteDoc(leaderboardDocRef);
            }

          // State'leri sıfırla
          setStudents([]);
          setUnits([]);
          setQuestions([]);
          setAppSettings(null);
          setSelectedStudent(null);
          setSelectedUnit(null);
          setInitialStudentViewMode('select');
          setCurrentView('main');

          setModal({ ...modal, isOpen: false }); // Modalı kapat
          setModal({
            isOpen: true,
            title: 'Başarılı',
            message: 'Uygulama verileri başarıyla sıfırlandı.',
            onClose: () => setModal({ ...modal, isOpen: false }),
          });
        } catch (e) {
          console.error("Uygulama sıfırlanırken hata:", e);
          setModal({
            isOpen: true,
            title: 'Hata',
            message: `Uygulama sıfırlanırken bir hata oluştu: ${e.message}`,
            onClose: () => setModal({ ...modal, isOpen: false }),
          });
        }
      },
      onClose: () => setModal({ ...modal, isOpen: false }),
    });
  };

  // Liderlik Tablosu Bileşeni
  const Leaderboard = useCallback(() => {
    const [leaderboardData, setLeaderboardData] = useState([]);

    useEffect(() => {
      if (!db) return;

      const leaderboardColRef = collection(db, `artifacts/${appId}/public/data/leaderboard`);
      const unsubscribe = onSnapshot(leaderboardColRef, (snapshot) => {
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        // Puanlara göre azalan sırada sırala
        data.sort((a, b) => b.score - a.score);
        setLeaderboardData(data);
      }, (error) => console.error("Liderlik tablosunu dinlerken hata:", error));

      return () => unsubscribe();
    }, [db]);

    return (
      <div className="w-full bg-blue-700 text-white p-4 rounded-b-lg shadow-lg mb-6">
        <h2 className="text-2xl font-bold text-center mb-4">Liderlik Tablosu</h2>
        {leaderboardData.length === 0 ? (
          <p className="text-center text-blue-100">Henüz liderlik tablosu boş. İlk puanı sen kazan!</p>
        ) : (
          <div className="overflow-x-auto">
            <table className="min-w-full bg-blue-800 rounded-lg overflow-hidden">
              <thead>
                <tr className="bg-blue-900">
                  <th className="py-2 px-4 text-left text-sm font-semibold">Sıra</th>
                  <th className="py-2 px-4 text-left text-sm font-semibold">Öğrenci</th>
                  <th className="py-2 px-4 text-left text-sm font-semibold">Puan</th>
                </tr>
              </thead>
              <tbody>
                {leaderboardData.slice(0, 10).map((entry, index) => ( // İlk 10'u göster
                  <tr key={entry.id} className={`${index % 2 === 0 ? 'bg-blue-700' : 'bg-blue-600'} hover:bg-blue-500 transition-colors`}>
                    <td className="py-2 px-4 text-sm">{index + 1}.</td>
                    <td className="py-2 px-4 text-sm">{entry.name}</td>
                    <td className="py-2 px-4 text-sm font-medium">{entry.score}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    );
  }, [db]);

  // Ana Ekran Bileşeni
  const MainScreen = useCallback(() => {
    const handleStartQuizFlow = () => {
      if (students.length === 0) {
        setInitialStudentViewMode('register'); // Öğrenci yoksa kayıt moduna geç
      } else {
        setInitialStudentViewMode('select'); // Öğrenci varsa seçme moduna geç
      }
      setCurrentView('studentSelection');
    };

    const handleOpenTools = () => {
      setCurrentView('tools'); // Yeni araçlar ekranına git
    };

    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-4">
        <Leaderboard />
        <h1 className="text-4xl font-extrabold text-gray-800 mb-8 text-center leading-tight">
          Bilgi Yarışması
        </h1>
        <div className="flex flex-col space-y-6 w-full max-w-sm">
          <button
            onClick={handleStartQuizFlow}
            className="w-full bg-green-600 text-white py-4 px-6 rounded-xl shadow-lg hover:bg-green-700 transition-all duration-300 transform hover:scale-105 font-bold text-lg"
          >
            Yarışmaya Başla
          </button>
          <button
            onClick={handleOpenTools}
            className="w-full bg-purple-600 text-white py-4 px-6 rounded-xl shadow-lg hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 font-bold text-lg"
          >
            Araçlar
          </button>
        </div>
        {userId && (
          <p className="mt-8 text-sm text-gray-600">
            Kullanıcı Kimliği: <span className="font-mono">{userId}</span>
          </p>
        )}
      </div>
    );
  }, [Leaderboard, students, userId, setInitialStudentViewMode]);

  // Öğrenci Seçim Bileşeni (MainScreen'den çağrılır)
  const StudentSelection = useCallback(({ initialMode }) => { // Accept initialMode prop
    const [isRegistering, setIsRegistering] = useState(initialMode === 'register'); // Initialize based on prop
    const [newStudentName, setNewStudentName] = useState('');
    const [newStudentSurname, setNewStudentSurname] = useState(''); // Soyad alanı isteğe bağlı olarak kalsın

    // If initialMode changes, update isRegistering
    useEffect(() => {
      setIsRegistering(initialMode === 'register');
      // Reset form fields when mode changes
      setNewStudentName('');
      setNewStudentSurname('');
    }, [initialMode]);

    const handleRegisterStudent = async () => {
      if (!newStudentName.trim()) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Öğrenci adı boş olamaz.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      try {
        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/students`), {
          name: newStudentName.trim(),
          surname: newStudentSurname.trim(), // Soyadı da kaydediyoruz
          score: 0,
          createdAt: new Date(),
        });
        setNewStudentName('');
        setNewStudentSurname('');
        setIsRegistering(false); // Kayıt sonrası formu kapat
        setModal({
          isOpen: true,
          title: 'Başarılı',
          message: 'Öğrenci başarıyla kaydedildi.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      } catch (e) {
        console.error("Öğrenci kaydederken hata:", e);
        setModal({
          isOpen: true,
          title: 'Hata',
          message: `Öğrenci kaydedilirken bir hata oluştu: ${e.message}`,
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      }
    };

    const handleSelectStudent = (student) => {
      setSelectedStudent(student);
      setCurrentView('unitSelection');
    };

    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-4">
        <h1 className="text-3xl font-bold text-gray-800 mb-6">Öğrenci Seç veya Kaydet</h1>
        <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
          {isRegistering ? (
            <div className="space-y-4">
              <input
                type="text"
                placeholder="Öğrenci Adı"
                value={newStudentName}
                onChange={(e) => setNewStudentName(e.target.value)}
                className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
              />
              {/* Soyad alanı isteğe bağlı olarak kalmaya devam ediyor */}
              <input
                type="text"
                placeholder="Öğrenci Soyadı (İsteğe Bağlı)"
                value={newStudentSurname}
                onChange={(e) => setNewStudentSurname(e.target.value)}
                className="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
              />
              <button
                onClick={handleRegisterStudent}
                className="w-full bg-green-600 text-white py-3 rounded-md hover:bg-green-700 transition-colors font-semibold"
              >
                Kaydet
              </button>
              <button
                onClick={() => setIsRegistering(false)}
                className="w-full bg-gray-300 text-gray-800 py-3 rounded-md hover:bg-gray-400 transition-colors font-semibold"
              >
                Vazgeç
              </button>
            </div>
          ) : (
            <>
              <h2 className="text-xl font-semibold text-gray-700 mb-4">Mevcut Öğrenciler</h2>
              {students.length === 0 ? (
                <p className="text-gray-600 mb-4">Henüz kayıtlı öğrenci yok.</p>
              ) : (
                <ul className="space-y-3 mb-6 max-h-60 overflow-y-auto pr-2">
                  {students.map((student) => (
                    <li key={student.id} className="flex items-center justify-between bg-gray-50 p-3 rounded-lg shadow-sm hover:bg-gray-100 transition-colors">
                      <span className="text-gray-800 font-medium">{student.name} {student.surname}</span>
                      <button
                        onClick={() => handleSelectStudent(student)}
                        className="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors text-sm"
                      >
                        Seç
                      </button>
                    </li>
                  ))}
                </ul>
              )}
              <button
                onClick={() => setIsRegistering(true)}
                className="w-full bg-indigo-600 text-white py-3 rounded-md hover:bg-indigo-700 transition-colors font-semibold"
              >
                Yeni Öğrenci Kaydet
              </button>
            </>
          )}
          <button
            onClick={() => setCurrentView('main')}
            className="w-full mt-6 bg-gray-500 text-white py-3 rounded-md hover:bg-gray-600 transition-colors font-semibold"
          >
            Geri
          </button>
        </div>
      </div>
    );
  }, [db, userId, students, modal, setSelectedStudent, setCurrentView]); // Added dependencies

  // Öğrenci Yönetimi Alt Bileşeni
  const StudentManagement = ({ db, userId, students, setModal, modal, setCurrentView }) => { // Added setCurrentView
    const [editingStudent, setEditingStudent] = useState(null);
    const [editName, setEditName] = useState('');
    const [editSurname, setEditSurname] = useState('');
    const [editScore, setEditScore] = useState(0);

    const handleEditClick = (student) => {
      setEditingStudent(student);
      setEditName(student.name);
      setEditSurname(student.surname);
      setEditScore(student.score);
    };

    const handleSaveEdit = async () => {
      if (!editingStudent || !editName.trim()) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Öğrenci adı boş olamaz.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      try {
        const studentDocRef = doc(db, `artifacts/${appId}/users/${userId}/students`, editingStudent.id);
        await updateDoc(studentDocRef, {
          name: editName.trim(),
          surname: editSurname.trim(),
          score: Number(editScore),
        });
        setEditingStudent(null);
        setModal({
          isOpen: true,
          title: 'Başarılı',
          message: 'Öğrenci bilgileri güncellendi.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      } catch (e) {
        console.error("Öğrenci güncellerken hata:", e);
        setModal({
          isOpen: true,
          title: 'Hata',
          message: `Öğrenci güncellenirken bir hata oluştu: ${e.message}`,
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      }
    };

    const handleDeleteStudent = (studentId) => {
      setModal({
        isOpen: true,
        title: 'Öğrenci Sil',
        message: 'Bu öğrenciyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.',
        showConfirmButton: true,
        onConfirm: async () => {
          try {
            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/students`, studentId));
            setModal({ ...modal, isOpen: false }); // Modalı kapat
            setModal({
              isOpen: true,
              title: 'Başarılı',
              message: 'Öğrenci başarıyla silindi.',
              onClose: () => setModal({ ...modal, isOpen: false }),
            });
          } catch (e) {
            console.error("Öğrenci silerken hata:", e);
            setModal({
              isOpen: true,
              title: 'Hata',
              message: `Öğrenci silinirken bir hata oluştu: ${e.message}`,
              onClose: () => setModal({ ...modal, isOpen: false }),
            });
          }
        },
        onClose: () => setModal({ ...modal, isOpen: false }),
      });
    };

    return (
      <div className="bg-white p-6 rounded-xl shadow-md">
        <h3 className="text-2xl font-semibold text-gray-800 mb-4">Öğrenci Yönetimi</h3>
        {students.length === 0 ? (
          <p className="text-gray-600 mb-4">Henüz kayıtlı öğrenci yok.</p>
        ) : (
          <ul className="space-y-3 mb-6 max-h-80 overflow-y-auto pr-2">
            {students.map((student) => (
              <li key={student.id} className="flex flex-col sm:flex-row items-start sm:items-center justify-between bg-gray-50 p-4 rounded-lg shadow-sm">
                <div className="flex-grow mb-2 sm:mb-0">
                  <span className="text-gray-800 font-medium">{student.name} {student.surname}</span>
                  <span className="text-gray-600 text-sm ml-2"> (Puan: {student.score})</span>
                </div>
                <div className="flex space-x-2">
                  <button
                    onClick={() => handleEditClick(student)}
                    className="bg-yellow-500 text-white px-3 py-1 rounded-md hover:bg-yellow-600 transition-colors text-sm"
                  >
                    Düzenle
                  </button>
                  <button
                    onClick={() => handleDeleteStudent(student.id)}
                    className="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition-colors text-sm"
                  >
                    Sil
                  </button>
                </div>
              </li>
            ))}
          </ul>
        )}

        {editingStudent && (
          <div className="mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50 space-y-3">
            <h4 className="text-lg font-semibold text-gray-800">Öğrenciyi Düzenle: {editingStudent.name}</h4>
            <input
              type="text"
              placeholder="Ad"
              value={editName}
              onChange={(e) => setEditName(e.target.value)}
              className="w-full p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
            />
            <input
              type="text"
              placeholder="Soyad"
              value={editSurname}
              onChange={(e) => setEditSurname(e.target.value)}
              className="w-full p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
            />
            <input
              type="number"
              placeholder="Puan"
              value={editScore}
              onChange={(e) => setEditScore(Number(e.target.value))}
              className="w-full p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
            />
            <div className="flex space-x-2 justify-end">
              <button
                onClick={handleSaveEdit}
                className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors text-sm"
              >
                Kaydet
              </button>
              <button
                onClick={() => setEditingStudent(null)}
                className="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors text-sm"
              >
                İptal
              </button>
            </div>
          </div>
        )}
        <button
          onClick={() => setCurrentView('tools')} // Geri tuşu ile araçlar ekranına dön
          className="w-full mt-6 bg-gray-500 text-white py-3 rounded-md hover:bg-gray-600 transition-colors font-semibold"
        >
          Geri
        </button>
      </div>
    );
  };

  // Soru Yönetimi Alt Bileşeni
  const QuestionManagement = ({ db, userId, units, questions, setModal, modal, setCurrentView }) => { // Added setCurrentView
    const [newUnitName, setNewUnitName] = useState('');
    const [editingUnit, setEditingUnit] = useState(null);
    const [editUnitName, setEditUnitName] = useState('');
    const [selectedUnitForQuestions, setSelectedUnitForQuestions] = useState(null);

    const [showAddQuestionForm, setShowAddQuestionForm] = useState(false);
    const [currentQuestion, setCurrentQuestion] = useState(null); // Düzenlenen soru
    const [questionText, setQuestionText] = useState('');
    const [optionA, setOptionA] = useState('');
    const [optionB, setOptionB] = useState('');
    const [optionC, setOptionC] = useState('');
    const [optionD, setOptionD] = useState('');
    const [correctAnswer, setCorrectAnswer] = useState('');
    const [difficulty, setDifficulty] = useState('Normal');
    const [questionPoints, setQuestionPoints] = useState(10);

    const [bulkFile, setBulkFile] = useState(null);
    const [bulkPreview, setBulkPreview] = useState([]);
    const [bulkErrors, setBulkErrors] = useState([]);
    
    // PDF ile ilgili state'ler kaldırıldı
    // const [isPdfProcessing, setIsPdfProcessing] = useState(false);
    // const [isPdfJsLoading, setIsPdfJsLoading] = useState(true);

    // PDF.js kütüphanesini dinamik olarak yükleme useEffect'i kaldırıldı
    // useEffect(() => { ... }, []);


    // Helper functions for options
    const getOptionValue = (char) => {
      switch (char) {
        case 'A': return optionA;
        case 'B': return optionB;
        case 'C': return optionC;
        case 'D': return optionD;
        default: return '';
      }
    };

    const setOptionValue = (char, value) => {
      switch (char) {
        case 'A': setOptionA(value); break;
        case 'B': setOptionB(value); break;
        case 'C': setOptionC(value); break;
        case 'D': setOptionD(value); break;
        default: break;
      }
    };

    // Ünite Ekle/Düzenle/Sil
    const handleAddUnit = async () => {
      if (!newUnitName.trim()) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Ünite adı boş olamaz.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      try {
        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/units`), {
          name: newUnitName.trim(),
          createdAt: new Date(),
        });
        setNewUnitName('');
        setModal({
          isOpen: true,
          title: 'Başarılı',
          message: 'Ünite başarıyla eklendi.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      } catch (e) {
        console.error("Ünite eklerken hata:", e);
        setModal({
          isOpen: true,
          title: 'Hata',
          message: `Ünite eklenirken bir hata oluştu: ${e.message}`,
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      }
    };

    const handleEditUnitClick = (unit) => {
      setEditingUnit(unit);
      setEditUnitName(unit.name);
    };

    const handleSaveUnitEdit = async () => {
      if (!editingUnit || !editUnitName.trim()) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Ünite adı boş olamaz.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      try {
        const unitDocRef = doc(db, `artifacts/${appId}/users/${userId}/units`, editingUnit.id);
        await updateDoc(unitDocRef, { name: editUnitName.trim() });
        setEditingUnit(null);
        setModal({
          isOpen: true,
          title: 'Başarılı',
          message: 'Ünite adı güncellendi.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      } catch (e) {
        console.error("Ünite güncellerken hata:", e);
        setModal({
          isOpen: true,
          title: 'Hata',
          message: `Ünite güncellenirken bir hata oluştu: ${e.message}`,
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      }
    };

    const handleDeleteUnit = (unitId) => {
      setModal({
        isOpen: true,
        title: 'Ünite Sil',
        message: 'Bu üniteyi ve tüm sorularını silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.',
        showConfirmButton: true,
        onConfirm: async () => {
          try {
            // Üniteye ait tüm soruları sil
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/units/${unitId}/questions`));
            const querySnapshot = await getDocs(q);
            const deletePromises = querySnapshot.docs.map(d => deleteDoc(d.ref));
            await Promise.all(deletePromises);

            // Üniteyi sil
            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/units`, unitId));
            setModal({ ...modal, isOpen: false }); // Modalı kapat
            setModal({
              isOpen: true,
              title: 'Başarılı',
              message: 'Ünite ve ilgili sorular başarıyla silindi.',
              onClose: () => setModal({ ...modal, isOpen: false }),
            });
            if (selectedUnitForQuestions && selectedUnitForQuestions.id === unitId) {
              setSelectedUnitForQuestions(null); // Seçili ünite silindiyse sıfırla
            }
          } catch (e) {
            console.error("Ünite silerken hata:", e);
            setModal({
              isOpen: true,
              title: 'Hata',
              message: `Ünite silinirken bir hata oluştu: ${e.message}`,
              onClose: () => setModal({ ...modal, isOpen: false }),
            });
          }
        },
        onClose: () => setModal({ ...modal, isOpen: false }),
      });
    };

    // Soru Ekle/Düzenle
    const resetQuestionForm = () => {
      setQuestionText('');
      setOptionA('');
      setOptionB('');
      setOptionC('');
      setOptionD('');
      setCorrectAnswer('');
      setDifficulty('Normal');
      setQuestionPoints(10);
      setCurrentQuestion(null);
      setShowAddQuestionForm(false);
    };

    const handleAddOrUpdateQuestion = async () => {
      if (!selectedUnitForQuestions) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Lütfen önce bir ünite seçin.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      if (!questionText.trim() || !optionA.trim() || !optionB.trim() || !optionC.trim() || !optionD.trim() || !correctAnswer.trim()) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Lütfen tüm soru alanlarını doldurun.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      if (!['A', 'B', 'C', 'D'].includes(correctAnswer.toUpperCase())) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Doğru cevap A, B, C veya D olmalıdır.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }

      const questionData = {
        text: questionText.trim(),
        options: { A: optionA.trim(), B: optionB.trim(), C: optionC.trim(), D: optionD.trim() },
        correctAnswer: correctAnswer.toUpperCase(),
        difficulty: difficulty,
        points: Number(questionPoints),
        createdAt: new Date(),
        unitId: selectedUnitForQuestions.id,
      };

      try {
        if (currentQuestion) {
          // Soru düzenleniyor
          await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/units/${selectedUnitForQuestions.id}/questions`, currentQuestion.id), questionData);
          setModal({
            isOpen: true,
            title: 'Başarılı',
            message: 'Soru başarıyla güncellendi.',
            onClose: () => setModal({ ...modal, isOpen: false }),
          });
        } else {
          // Yeni soru ekleniyor
          await addDoc(collection(db, `artifacts/${appId}/users/${userId}/units/${selectedUnitForQuestions.id}/questions`), questionData);
          setModal({
            isOpen: true,
            title: 'Başarılı',
            message: 'Soru başarıyla eklendi.',
            onClose: () => setModal({ ...modal, isOpen: false }),
          });
        }
        resetQuestionForm();
      } catch (e) {
        console.error("Soru eklerken/güncellerken hata:", e);
        setModal({
          isOpen: true,
          title: 'Hata',
          message: `Soru eklenirken/güncellenirken bir hata oluştu: ${e.message}`,
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      }
    };

    const handleEditQuestionClick = (question) => {
      setCurrentQuestion(question);
      setQuestionText(question.text);
      setOptionA(question.options.A);
      setOptionB(question.options.B);
      setOptionC(question.options.C);
      setOptionD(question.options.D);
      setCorrectAnswer(question.correctAnswer);
      setDifficulty(question.difficulty);
      setQuestionPoints(question.points);
      setShowAddQuestionForm(true);
    };

    const handleDeleteQuestion = (questionId) => {
      setModal({
        isOpen: true,
        title: 'Soru Sil',
        message: 'Bu soruyu silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.',
        showConfirmButton: true,
        onConfirm: async () => {
          try {
            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/units/${selectedUnitForQuestions.id}/questions`, questionId));
            setModal({ ...modal, isOpen: false });
            setModal({
              isOpen: true,
              title: 'Başarılı',
              message: 'Soru başarıyla silindi.',
              onClose: () => setModal({ ...modal, isOpen: false }),
            });
          } catch (e) {
            console.error("Soru silerken hata:", e);
            setModal({
              isOpen: true,
              title: 'Hata',
              message: `Soru silinirken bir hata oluştu: ${e.message}`,
              onClose: () => setModal({ ...modal, isOpen: false }),
            });
          }
        },
        onClose: () => setModal({ ...modal, isOpen: false }),
      });
    };

    // Toplu Soru Yükleme (CSV)
    const handleCsvFileChange = (e) => {
      setBulkFile(e.target.files[0]);
      setBulkPreview([]);
      setBulkErrors([]);
    };

    const handleDownloadTemplate = () => {
      const headers = "SoruMetni,SecenekA,SecenekB,SecenekC,SecenekD,DogruCevap,Puan,ZorlukSeviyesi\n";
      const example = "Türkiye'nin başkenti neresidir?,Ankara,İstanbul,İzmir,Bursa,A,10,Normal\n";
      const blob = new Blob([headers, example], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'soru_sablonu.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    };

    const handleUploadBulkCsvQuestions = () => {
      if (!bulkFile) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Lütfen yüklenecek bir dosya seçin.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      if (!selectedUnitForQuestions) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Lütfen soruları yüklemek için bir ünite seçin.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }

      const reader = new FileReader();
      reader.onload = async (e) => {
        const text = e.target.result;
        const lines = text.split('\n').filter(line => line.trim() !== '');
        const headers = lines[0].split(',').map(h => h.trim());
        const questionsToProcess = [];
        const errors = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',').map(v => v.trim());
          if (values.length !== headers.length) {
            errors.push(`Satır ${i + 1}: Eksik veya fazla sütun.`);
            continue;
          }

          const question = {};
          headers.forEach((header, index) => {
            question[header] = values[index];
          });

          // Doğrulama
          if (!question.SoruMetni || !question.SecenekA || !question.SecenekB || !question.SecenekC || !question.SecenekD || !question.DogruCevap || !question.Puan || !question.ZorlukSeviyesi) {
            errors.push(`Satır ${i + 1}: Eksik alanlar.`);
            continue;
          }
          if (!['A', 'B', 'C', 'D'].includes(question.DogruCevap.toUpperCase())) {
            errors.push(`Satır ${i + 1}: Geçersiz DoğruCevap (${question.DogruCevap}). A, B, C veya D olmalı.`);
            continue;
          }
          if (isNaN(Number(question.Puan)) || Number(question.Puan) <= 0) {
            errors.push(`Satır ${i + 1}: Geçersiz Puan (${question.Puan}). Pozitif bir sayı olmalı.`);
            continue;
          }
          if (!['Kolay', 'Normal', 'Zor'].includes(question.ZorlukSeviyesi)) {
            errors.push(`Satır ${i + 1}: Geçersiz ZorlukSeviyesi (${question.ZorlukSeviyesi}). Kolay, Normal veya Zor olmalı.`);
            continue;
          }

          questionsToProcess.push({
            text: question.SoruMetni,
            options: { A: question.SecenekA, B: question.SecenekB, C: question.SecenekC, D: question.SecenekD },
            correctAnswer: question.DogruCevap.toUpperCase(),
            points: Number(question.Puan),
            difficulty: question.ZorlukSeviyesi,
            unitId: selectedUnitForQuestions.id,
            createdAt: new Date(),
          });
        }
        setBulkPreview(questionsToProcess);
        setBulkErrors(errors);

        if (errors.length > 0) {
          setModal({
            isOpen: true,
            title: 'Yükleme Hatası',
            message: `Dosyada hatalar bulundu. Lütfen önizlemeyi kontrol edin.`,
            onClose: () => setModal({ ...modal, isOpen: false }),
          });
        } else if (questionsToProcess.length === 0) {
          setModal({
            isOpen: true,
            title: 'Uyarı',
            message: 'Dosyada geçerli soru bulunamadı.',
            onClose: () => setModal({ ...modal, isOpen: false }),
          });
        } else {
          setModal({
            isOpen: true,
            title: 'Önizleme Hazır',
            message: `${questionsToProcess.length} adet soru başarıyla okundu. Lütfen önizlemeyi kontrol edip kaydedin.`,
            onClose: () => setModal({ ...modal, isOpen: false }),
          });
        }
      };
      reader.readAsText(bulkFile);
    };

    const handleSaveBulkQuestions = async () => {
      if (bulkPreview.length === 0) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Kaydedilecek soru bulunamadı.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }
      if (!selectedUnitForQuestions) {
        setModal({
          isOpen: true,
          title: 'Uyarı',
          message: 'Lütfen soruları kaydetmek için bir ünite seçin.',
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        return;
      }

      try {
        const batch = [];
        bulkPreview.forEach(q => {
          batch.push(addDoc(collection(db, `artifacts/${appId}/users/${userId}/units/${selectedUnitForQuestions.id}/questions`), q));
        });
        await Promise.all(batch);
        setModal({
          isOpen: true,
          title: 'Başarılı',
          message: `${bulkPreview.length} adet soru başarıyla eklendi.`,
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
        setBulkFile(null);
        setBulkPreview([]);
        setBulkErrors([]);
      } catch (e) {
        console.error("Toplu soru kaydederken hata:", e);
        setModal({
          isOpen: true,
          title: 'Hata',
          message: `Toplu soru kaydederken bir hata oluştu: ${e.message}`,
          onClose: () => setModal({ ...modal, isOpen: false }),
        });
      }
    };

    // PDF ile ilgili fonksiyonlar kaldırıldı
    // const handlePdfFileChange = (e) => { ... };
    // const handleUploadPdfQuestions = async () => { ... };


    return (
      <div className="bg-white p-6 rounded-xl shadow-md">
        <h3 className="text-2xl font-semibold text-gray-800 mb-4">Soru Yönetimi</h3>

        {/* Ünite Yönetimi */}
        <div className="mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50">
          <h4 className="text-xl font-semibold text-gray-700 mb-3">Ünite Yönetimi</h4>
          <div className="flex flex-col sm:flex-row gap-2 mb-4">
            <input
              type="text"
              placeholder="Yeni Ünite Adı"
              value={newUnitName}
              onChange={(e) => setNewUnitName(e.target.value)}
              className="flex-grow p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
            />
            <button
              onClick={handleAddUnit}
              className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors font-semibold"
            >
              Ünite Ekle
            </button>
          </div>

          {units.length === 0 ? (
            <p className="text-gray-600">Henüz ünite yok.</p>
          ) : (
            <ul className="space-y-2 max-h-40 overflow-y-auto pr-2">
              {units.map((unit) => (
                <li key={unit.id} className="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm">
                  {editingUnit && editingUnit.id === unit.id ? (
                    <div className="flex-grow flex gap-2">
                      <input
                        type="text"
                        value={editUnitName}
                        onChange={(e) => setEditUnitName(e.target.value)}
                        className="flex-grow p-1 border border-gray-300 rounded-md text-sm"
                      />
                      <button
                        onClick={handleSaveUnitEdit}
                        className="bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600 text-sm"
                      >
                        Kaydet
                      </button>
                      <button
                        onClick={() => setEditingUnit(null)}
                        className="bg-gray-300 text-gray-800 px-3 py-1 rounded-md hover:bg-gray-400 text-sm"
                      >
                        İptal
                      </button>
                    </div>
                  ) : (
                    <>
                      <span className="text-gray-800 font-medium">{unit.name}</span>
                      <div className="flex space-x-2">
                        <button
                          onClick={() => handleEditUnitClick(unit)}
                          className="bg-yellow-500 text-white px-3 py-1 rounded-md hover:bg-yellow-600 transition-colors text-sm"
                        >
                          Düzenle
                        </button>
                        <button
                          onClick={() => handleDeleteUnit(unit.id)}
                          className="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition-colors text-sm"
                        >
                          Sil
                        </button>
                      </div>
                    </>
                  )}
                </li>
              ))}
            </ul>
          )}
        </div>

        {/* Ünite Seçimi ve Soru Listesi */}
        <div className="mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50">
          <h4 className="text-xl font-semibold text-gray-700 mb-3">Soruları Yönet</h4>
          <select
            className="w-full p-2 border border-gray-300 rounded-md mb-4 focus:ring-1 focus:ring-blue-500"
            onChange={(e) => setSelectedUnitForQuestions(units.find(u => u.id === e.target.value))}
            value={selectedUnitForQuestions ? selectedUnitForQuestions.id : ''}
          >
            <option value="">Ünite Seçin</option>
            {units.map(unit => (
              <option key={unit.id} value={unit.id}>{unit.name}</option>
            ))}
          </select>

          {selectedUnitForQuestions && (
            <>
              <h5 className="text-lg font-semibold text-gray-800 mb-3">
                {selectedUnitForQuestions.name} Ünitesindeki Sorular ({questions.length} adet)
              </h5>
              <button
                onClick={() => setShowAddQuestionForm(true)}
                className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors font-semibold mb-4"
              >
                Yeni Soru Ekle
              </button>
              {questions.length === 0 ? (
                <p className="text-gray-600">Bu ünitede henüz soru yok.</p>
              ) : (
                <ul className="space-y-2 max-h-60 overflow-y-auto pr-2">
                  {questions.map((q) => (
                    <li key={q.id} className="bg-white p-3 rounded-lg shadow-sm flex flex-col sm:flex-row items-start sm:items-center justify-between">
                      <div className="flex-grow mb-2 sm:mb-0">
                        <p className="text-gray-800 font-medium text-sm">{q.text}</p>
                        <p className="text-gray-600 text-xs">Doğru: {q.correctAnswer} | Puan: {q.points} | Zorluk: {q.difficulty}</p>
                      </div>
                      <div className="flex space-x-2">
                        <button
                          onClick={() => handleEditQuestionClick(q)}
                          className="bg-yellow-500 text-white px-3 py-1 rounded-md hover:bg-yellow-600 text-xs"
                        >
                          Düzenle
                        </button>
                        <button
                          onClick={() => handleDeleteQuestion(q.id)}
                          className="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 text-xs"
                        >
                          Sil
                        </button>
                      </div>
                    </li>
                  ))}
                </ul>
              )}
            </>
          )}
        </div>

        {/* Soru Ekleme/Düzenleme Formu */}
        {showAddQuestionForm && (
          <div className="mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <h4 className="text-xl font-semibold text-gray-700 mb-3">{currentQuestion ? 'Soruyu Düzenle' : 'Yeni Soru Ekle'}</h4>
            <div className="space-y-3">
              <textarea
                placeholder="Soru Metni"
                value={questionText}
                onChange={(e) => setQuestionText(e.target.value)}
                className="w-full p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 h-24"
              ></textarea>
              {['A', 'B', 'C', 'D'].map((char) => (
                <input
                  key={char}
                  type="text"
                  placeholder={`Seçenek ${char}`}
                  value={getOptionValue(char)}
                  onChange={(e) => setOptionValue(char, e.target.value)}
                  className="w-full p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
                />
              ))}
              <div className="flex items-center space-x-4">
                <label className="text-gray-700 font-medium">Doğru Cevap:</label>
                <select
                  value={correctAnswer}
                  onChange={(e) => setCorrectAnswer(e.target.value)}
                  className="p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Seçiniz</option>
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                  <option value="D">D</option>
                </select>
              </div>
              <div className="flex items-center space-x-4">
                <label className="text-gray-700 font-medium">Zorluk Seviyesi:</label>
                <select
                  value={difficulty}
                  onChange={(e) => setDifficulty(e.target.value)}
                  className="p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
                >
                  <option value="Kolay">Kolay</option>
                  <option value="Normal">Normal</option>
                  <option value="Zor">Zor</option>
                </select>
              </div>
              <div className="flex items-center space-x-4">
                <label className="text-gray-700 font-medium">Puan:</label>
                <input
                  type="number"
                  value={questionPoints}
                  onChange={(e) => setQuestionPoints(Number(e.target.value))}
                  className="p-2 border border-gray-300 rounded-md w-24 focus:ring-1 focus:ring-blue-500"
                  min="1"
                />
              </div>
              <div className="flex space-x-2 justify-end">
                <button
                  onClick={handleAddOrUpdateQuestion}
                  className="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors font-semibold"
                >
                  {currentQuestion ? 'Güncelle' : 'Ekle'}
                </button>
                <button
                  onClick={resetQuestionForm}
                  className="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors font-semibold"
                >
                  İptal
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Toplu Soru Yükleme (CSV) */}
        <div className="mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50">
          <h4 className="text-xl font-semibold text-gray-700 mb-3">Toplu Soru Yükleme (CSV)</h4>
          <p className="text-gray-600 text-sm mb-3">
            Sorularınızı CSV formatında yükleyebilirsiniz. Eğer Excel kullanıyorsanız, lütfen dosyanızı "Farklı Kaydet" seçeneği ile "CSV (Virgülle Ayrılmış)" olarak kaydedip yükleyiniz. Şablonu indirip doldurunuz.
          </p>
          <button
            onClick={handleDownloadTemplate}
            className="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors font-semibold mb-4"
          >
            Şablonu İndir
          </button>
          <div className="flex flex-col sm:flex-row items-center gap-3 mb-4">
            <input
              type="file"
              accept=".csv"
              onChange={handleCsvFileChange}
              className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"
            />
            <button
              onClick={handleUploadBulkCsvQuestions}
              className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors font-semibold w-full sm:w-auto"
            >
              CSV Dosyasını Yükle
            </button>
          </div>
        </div>

        {/* PDF yükleme bölümü kaldırıldı */}
        {/*
        <div className="mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50">
          <h4 className="text-xl font-semibold text-gray-700 mb-3">PDF'ten Soru Yükle (Yapay Zeka Destekli)</h4>
          <p className="text-gray-600 text-sm mb-3">
            PDF dosyanızdaki soruları yapay zeka desteğiyle otomatik olarak çıkarabilirsiniz.
          </p>
          <div className="flex flex-col sm:flex-row items-center gap-3 mb-4">
            <input
              type="file"
              accept=".pdf"
              onChange={handlePdfFileChange}
              className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"
            />
            <button
              onClick={handleUploadPdfQuestions}
              disabled={isPdfProcessing || isPdfJsLoading}
              className={`bg-blue-600 text-white px-4 py-2 rounded-md font-semibold w-full sm:w-auto
                ${isPdfProcessing || isPdfJsLoading ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-700 transition-colors'}
              `}
            >
              {isPdfProcessing ? 'İşleniyor...' : (isPdfJsLoading ? 'Yükleniyor...' : 'PDF Yükle ve Çıkar')}
            </button>
          </div>
        </div>
        */}


        {bulkPreview.length > 0 && (
          <div className="mt-4 p-4 border border-gray-300 rounded-lg bg-white">
            <h5 className="text-lg font-semibold text-gray-800 mb-2">Yükleme Önizlemesi ({bulkPreview.length} Soru)</h5>
            {bulkErrors.length > 0 && (
              <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4">
                <strong className="font-bold">Hatalar:</strong>
                <ul className="list-disc list-inside mt-2">
                  {bulkErrors.map((err, idx) => <li key={idx} className="text-sm">{err}</li>)}
                </ul>
              </div>
            )}
            <ul className="space-y-2 max-h-60 overflow-y-auto pr-2">
              {bulkPreview.map((q, index) => (
                <li key={index} className="bg-gray-50 p-2 rounded-md text-sm">
                  <p className="font-medium">{q.text}</p>
                  <p className="text-gray-600">Doğru: {q.correctAnswer} | Puan: {q.points} | Zorluk: {q.difficulty}</p>
                </li>
              ))}
            </ul>
            <button
              onClick={handleSaveBulkQuestions}
              className="mt-4 bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors font-semibold w-full"
            >
              Soruları Kaydet
            </button>
          </div>
        )}
        <button
          onClick={() => setCurrentView('tools')} // Geri tuşu ile araçlar ekranına dön
          className="w-full mt-6 bg-gray-500 text-white py-3 rounded-md hover:bg-gray-600 transition-colors font-semibold"
        >
          Geri
        </button>
      </div>
    );
  };

  // Ayarlar Bileşeni
  const Settings = useCallback(({ db, userId, appSettings, students, units, questions, setModal, modal, handleUpdateSetting, setCurrentView }) => {
    // Yerel durum olarak ayarları yönet
    const [localQuizSettings, setLocalQuizSettings] = useState(appSettings);

    // appSettings prop'u değiştiğinde yerel durumu güncelle
    useEffect(() => {
      setLocalQuizSettings(appSettings);
    }, [appSettings]);

    const handleLocalSettingChange = (key, value) => {
      setLocalQuizSettings(prev => ({ ...prev, [key]: value }));
    };

    const handleSaveQuizSettings = async () => {
      // Tüm yerel ayarları tek tek güncellemek yerine, bir obje olarak gönderiyoruz.
      // handleUpdateSetting fonksiyonu tek bir anahtar-değer çiftini güncelliyor.
      // Bu yüzden her bir ayarı döngü ile güncellemek yerine, bir obje olarak gönderebiliriz.
      // Ancak mevcut handleUpdateSetting tek tek güncellediği için, burada her bir ayarı çağıracağız.
      // Daha verimli bir yaklaşım, handleUpdateSetting'i tüm ayarlar objesini alacak şekilde değiştirmek olurdu.
      // Şimdilik mevcut yapıyı koruyarak her bir ayarı ayrı ayrı güncelleyelim.
      for (const key in localQuizSettings) {
        if (localQuizSettings.hasOwnProperty(key)) {
          await handleUpdateSetting(key, localQuizSettings[key]);
        }
      }
      setModal({
        isOpen: true,
        title: 'Başarılı',
        message: 'Ayarlar başarıyla kaydedildi.',
        onClose: () => setModal({ ...modal, isOpen: false }),
      });
    };

    return (
      <div className="flex flex-col items-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-4">
        <h1 className="text-3xl font-bold text-gray-800 mb-6 mt-4">Yarışma Ayarları</h1>
        <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-3xl">
          {localQuizSettings && (
            <div className="space-y-6">
              {/* Süre Belirleme */}
              <div className="bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 className="text-xl font-semibold text-gray-800 mb-3">Süre Ayarları</h3>
                <div className="flex items-center justify-between py-2">
                  <label htmlFor="timePerQuestion" className="text-gray-700">Soru Başına Süre (Saniye):</label>
                  <input
                    id="timePerQuestion"
                    type="number"
                    min="5"
                    max="120"
                    value={localQuizSettings.timePerQuestion}
                    onChange={(e) => handleLocalSettingChange('timePerQuestion', Number(e.target.value))}
                    className="w-24 p-2 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500"
                  />
                </div>
              </div>

              {/* Puanlandırma Ayarları */}
              <div className="bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 className="text-xl font-semibold text-gray-800 mb-3">Puanlandırma Ayarları</h3>
                <div className="flex items-center justify-between py-2">
                  <label htmlFor="enableNegativeScoring" className="text-gray-700">Yanlış Cevapta Puan Eksilt:</label>
                  <input
                    id="enableNegativeScoring"
                    type="checkbox"
                    checked={localQuizSettings.enableNegativeScoring}
                    onChange={(e) => handleLocalSettingChange('enableNegativeScoring', e.target.checked)}
                    className="h-5 w-5 text-blue-600 rounded focus:ring-blue-500"
                  />
                </div>
                <div className="flex items-center justify-between py-2 mt-4">
                  <label htmlFor="enableFastAnswerBonus" className="text-gray-700">Hızlı Cevap Bonusu Ver:</label>
                  <input
                    id="enableFastAnswerBonus"
                    type="checkbox"
                    checked={localQuizSettings.enableFastAnswerBonus}
                    onChange={(e) => handleLocalSettingChange('enableFastAnswerBonus', e.target.checked)}
                    className="h-5 w-5 text-blue-600 rounded focus:ring-blue-500"
                  />
                </div>
                {localQuizSettings.enableFastAnswerBonus && (
                  <div className="space-y-2 mt-2 pl-6">
                    <div className="flex items-center justify-between py-1">
                      <label htmlFor="fastAnswerBonusTime" className="text-gray-600 text-sm">Bonus için Maksimum Süre (Saniye):</label>
                      <input
                        id="fastAnswerBonusTime"
                        type="number"
                        min="1"
                        value={localQuizSettings.fastAnswerBonusTime}
                        onChange={(e) => handleLocalSettingChange('fastAnswerBonusTime', Number(e.target.value))}
                        className="w-20 p-1 border border-gray-300 rounded-md text-sm focus:ring-1 focus:ring-blue-500"
                      />
                    </div>
                    <div className="flex items-center justify-between py-1">
                      <label htmlFor="fastAnswerBonusPoints" className="text-gray-600 text-sm">Bonus Puan Miktarı:</label>
                      <input
                        id="fastAnswerBonusPoints"
                        type="number"
                        min="1"
                        value={localQuizSettings.fastAnswerBonusPoints}
                        onChange={(e) => handleLocalSettingChange('fastAnswerBonusPoints', Number(e.target.value))}
                        className="w-20 p-1 border border-gray-300 rounded-md text-sm focus:ring-1 focus:ring-blue-500"
                      />
                    </div>
                  </div>
                )}
              </div>

              {/* Geri Bildirim Ayarları */}
              <div className="bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 className="text-xl font-semibold text-gray-800 mb-3">Geri Bildirim Ayarları</h3>
                <div className="flex items-center justify-between py-2">
                  <label htmlFor="showAnswerOnWrong" className="text-gray-700">Yanlış Cevapta Doğru Cevabı Göster:</label>
                  <input
                    id="showAnswerOnWrong"
                    type="checkbox"
                    checked={localQuizSettings.showAnswerOnWrong}
                    onChange={(e) => handleLocalSettingChange('showAnswerOnWrong', e.target.checked)}
                    className="h-5 w-5 text-blue-600 rounded focus:ring-blue-500"
                  />
                </div>
                {!localQuizSettings.showAnswerOnWrong && (
                  <p className="text-sm text-gray-500 mt-2">
                    *Bu seçenek kapalıyken, yanlış cevaplanan sorular ünite ekranında açılmamış gibi görünür.
                  </p>
                )}
              </div>
            </div>
          )}
          <div className="flex justify-end space-x-4 mt-8">
            <button
              onClick={handleSaveQuizSettings}
              className="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors font-semibold"
            >
              Kaydet
            </button>
            <button
              onClick={() => setCurrentView('tools')}
              className="px-6 py-3 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-semibold"
            >
              Geri
            </button>
          </div>
        </div>
      </div>
    );
  }, [db, userId, appSettings, modal, handleUpdateSetting, setCurrentView]);

  // Yeni Araçlar Ekranı Bileşeni
  const ToolsScreen = useCallback(() => {
    return (
      <div className="flex flex-col items-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-4">
        <h1 className="text-3xl font-bold text-gray-800 mb-6 mt-4">Araçlar</h1>
        <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg space-y-6">
          <button
            onClick={() => setCurrentView('settings')}
            className="w-full bg-purple-600 text-white py-4 px-6 rounded-xl shadow-lg hover:bg-purple-700 transition-all duration-300 transform hover:scale-105 font-bold text-lg"
          >
            Yarışma Ayarları
          </button>
          <button
            onClick={() => setCurrentView('studentManagement')}
            className="w-full bg-orange-600 text-white py-4 px-6 rounded-xl shadow-lg hover:bg-orange-700 transition-all duration-300 transform hover:scale-105 font-bold text-lg"
          >
            Öğrenci Yönetimi
          </button>
          <button
            onClick={() => setCurrentView('questionManagement')}
            className="w-full bg-teal-600 text-white py-4 px-6 rounded-xl shadow-lg hover:bg-teal-700 transition-all duration-300 transform hover:scale-105 font-bold text-lg"
          >
            Soru Yönetimi
          </button>
          <button
            onClick={handleResetApplication}
            className="w-full bg-red-600 text-white py-4 px-6 rounded-xl shadow-lg hover:bg-red-700 transition-all duration-300 transform hover:scale-105 font-bold text-lg"
          >
            Uygulamayı Sıfırla
          </button>
          <button
            onClick={() => setCurrentView('main')}
            className="w-full mt-6 bg-gray-500 text-white py-3 rounded-md hover:bg-gray-600 transition-colors font-semibold"
          >
            Geri
          </button>
        </div>
      </div>
    );
  }, [handleResetApplication]);


  // Ünite Seçim Ekranı Bileşeni
  const UnitSelectionScreen = useCallback(() => {
    const handleUnitSelect = (unit) => {
      setSelectedUnit(unit);
      setCurrentView('quizPlay');
    };

    return (
      <div className="flex flex-col items-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-4">
        <h1 className="text-3xl font-bold text-gray-800 mb-6 mt-4">Ünite Seçimi</h1>
        <p className="text-gray-700 mb-6 text-center">
          <span className="font-semibold">{selectedStudent?.name} {selectedStudent?.surname}</span> için oynamak istediğin üniteyi seç.
        </p>
        <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-3xl grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {units.length === 0 ? (
            <p className="col-span-full text-center text-gray-600">Henüz ünite tanımlanmamış. Ayarlar'dan ünite ekleyebilirsiniz.</p>
          ) : (
            units.map((unit) => {
              const unitQuestions = questions.filter(q => q.unitId === unit.id);
              return (
                <button
                  key={unit.id}
                  onClick={() => handleUnitSelect(unit)}
                  className="bg-blue-500 text-white p-6 rounded-lg shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:scale-105 flex flex-col items-center justify-center text-center h-32"
                >
                  <span className="text-xl font-bold mb-2">{unit.name}</span>
                  <span className="text-sm">{unitQuestions.length} Soru</span>
                </button>
              );
            })
          )}
        </div>
        <button
          onClick={() => setCurrentView('studentSelection')}
          className="w-full max-w-sm mt-8 bg-gray-500 text-white py-3 rounded-md hover:bg-gray-600 transition-colors font-semibold"
        >
          Geri
        </button>
      </div>
    );
  }, [selectedStudent, units, questions]);

  // Quiz Oynama Ekranı Bileşeni
  const QuizPlayScreen = useCallback(() => {
    const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
    const [answeredQuestions, setAnsweredQuestions] = useState({}); // { questionId: { status: 'correct'/'wrong'/'skipped', score: X } }
    const [timer, setTimer] = useState(appSettings?.timePerQuestion || 30);
    const [quizEnded, setQuizEnded] = useState(false);
    const [showResult, setShowResult] = useState(false);
    const [selectedOption, setSelectedOption] = useState(null);
    const [isAnswerCorrect, setIsAnswerCorrect] = useState(null); // true/false

    const unitQuestions = questions.filter(q => q.unitId === selectedUnit?.id);
    const currentQuestion = unitQuestions[currentQuestionIndex];

    // Timer
    useEffect(() => {
      if (quizEnded || !currentQuestion || showResult) return;

      const interval = setInterval(() => {
        setTimer((prev) => {
          if (prev <= 1) {
            clearInterval(interval);
            handleAnswerSubmit(null); // Süre doldu, cevap verilmedi
            return 0;
          }
          return prev - 1;
        });
      }, 1000);

      return () => clearInterval(interval);
    }, [currentQuestion, quizEnded, showResult, appSettings?.timePerQuestion]);

    // Soru değiştiğinde veya yeni soruya geçildiğinde timer'ı sıfırla
    useEffect(() => {
      if (currentQuestion) {
        setTimer(appSettings?.timePerQuestion || 30);
        setSelectedOption(null);
        setIsAnswerCorrect(null);
        setShowResult(false);
      }
    }, [currentQuestion, appSettings?.timePerQuestion]);

    const handleAnswerSubmit = async (option) => {
      if (showResult) return; // Zaten cevap gösteriliyorsa tekrar işlem yapma

      const correct = option === currentQuestion.correctAnswer;
      let scoreChange = 0;
      let bonusScore = 0;

      if (correct) {
        scoreChange = currentQuestion.points;
        // Hızlı cevap bonusu kontrolü
        if (appSettings?.enableFastAnswerBonus && (appSettings?.timePerQuestion - timer) <= appSettings?.fastAnswerBonusTime) {
          bonusScore = appSettings.fastAnswerBonusPoints;
          scoreChange += bonusScore;
        }
      } else {
        if (appSettings?.enableNegativeScoring) {
          scoreChange = -currentQuestion.points; // Yanlış cevapta puan eksilt
        } else {
          scoreChange = 0; // Yanlış cevapta puan eksiltme yoksa 0
        }
      }

      setSelectedOption(option);
      setIsAnswerCorrect(correct);
      setShowResult(true); // Cevabı göster

      // Cevap durumunu kaydet
      const newAnsweredQuestions = {
        ...answeredQuestions,
        [currentQuestion.id]: {
          status: correct ? 'correct' : 'wrong',
          score: scoreChange,
          bonus: bonusScore,
          answered: true,
          optionSelected: option,
        },
      };
      setAnsweredQuestions(newAnsweredQuestions);

      // Öğrencinin toplam puanını güncelle
      if (selectedStudent && db && userId) {
        try {
          const studentRef = doc(db, `artifacts/${appId}/users/${userId}/students`, selectedStudent.id);
          const studentSnap = await getDoc(studentRef);
          if (studentSnap.exists()) {
            const currentScore = studentSnap.data().score || 0;
            const newScore = currentScore + scoreChange;
            await updateDoc(studentRef, { score: newScore });

            // Liderlik tablosunu güncelle (public data)
            const leaderboardRef = doc(db, `artifacts/${appId}/public/data/leaderboard`, selectedStudent.id);
            await setDoc(leaderboardRef, {
              name: selectedStudent.name,
              score: newScore,
              lastUpdated: new Date(),
            }, { merge: true });
          }
        } catch (e) {
          console.error("Puan güncellerken hata:", e);
        }
      }
    };

    const handleNextQuestion = () => {
      if (currentQuestionIndex < unitQuestions.length - 1) {
        setCurrentQuestionIndex(currentQuestionIndex + 1);
        setShowResult(false);
      } else {
        setQuizEnded(true);
      }
    };

    const handleSkipQuestion = () => {
      if (showResult) return; // Zaten cevap gösteriliyorsa tekrar işlem yapma

      const newAnsweredQuestions = {
        ...answeredQuestions,
        [currentQuestion.id]: {
          status: 'skipped',
          score: 0,
          bonus: 0,
          answered: true,
          optionSelected: null,
        },
      };
      setAnsweredQuestions(newAnsweredQuestions);

      if (currentQuestionIndex < unitQuestions.length - 1) {
        setCurrentQuestionIndex(currentQuestionIndex + 1);
        setShowResult(false);
      } else {
        setQuizEnded(true);
      }
    };

    const handleQuestionBoxClick = (index) => {
      setCurrentQuestionIndex(index);
      setShowResult(false); // Yeni soruya geçince cevabı gizle
    };

    const getQuestionBoxColor = (questionId) => {
      const status = answeredQuestions[questionId]?.status;
      if (status === 'correct') return 'bg-green-500';
      if (status === 'wrong') {
        return appSettings?.showAnswerOnWrong ? 'bg-red-500' : 'bg-blue-500'; // Yanlışta cevabı göstermiyorsa normal renk
      }
      if (status === 'skipped') return 'bg-yellow-500';
      return 'bg-blue-500'; // Oynanmamış veya henüz cevaplanmamış
    };

    if (!selectedUnit || unitQuestions.length === 0) {
      return (
        <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-4 text-center">
          <h1 className="text-3xl font-bold text-gray-800 mb-4">Ünite Seçilmedi veya Soru Yok</h1>
          <p className="text-gray-700 mb-6">Lütfen geri dönüp bir ünite seçin veya Ayarlar'dan bu üniteye soru ekleyin.</p>
          <button
            onClick={() => setCurrentView('unitSelection')}
            className="bg-gray-500 text-white py-3 px-6 rounded-md hover:bg-gray-600 transition-colors font-semibold"
          >
            Ünite Seçimine Geri Dön
          </button>
        </div>
      );
    }

    if (quizEnded) {
      const totalScore = Object.values(answeredQuestions).reduce((sum, q) => sum + q.score, 0);
      const correctCount = Object.values(answeredQuestions).filter(q => q.status === 'correct').length;
      const wrongCount = Object.values(answeredQuestions).filter(q => q.status === 'wrong').length;
      const skippedCount = Object.values(answeredQuestions).filter(q => q.status === 'skipped').length;

      return (
        <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-4 text-center">
          <h1 className="text-4xl font-bold text-gray-800 mb-6">Yarışma Bitti!</h1>
          <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md space-y-4">
            <p className="text-2xl font-semibold text-gray-800">Toplam Puan: <span className="text-green-600">{totalScore}</span></p>
            <p className="text-lg text-gray-700">Doğru Cevap: <span className="font-medium text-green-500">{correctCount}</span></p>
            <p className="text-lg text-gray-700">Yanlış Cevap: <span className="font-medium text-red-500">{wrongCount}</span></p>
            <p className="text-lg text-gray-700">Atlanan Soru: <span className="font-medium text-yellow-500">{skippedCount}</span></p>
          </div>
          <button
            onClick={() => {
              setCurrentView('main');
              setSelectedStudent(null);
              setSelectedUnit(null);
              setAnsweredQuestions({});
              setCurrentQuestionIndex(0);
              setQuizEnded(false);
            }}
            className="w-full max-w-sm mt-8 bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 transition-colors font-semibold"
          >
            Ana Ekrana Dön
          </button>
        </div>
      );
    }

    return (
      <div className="flex flex-col items-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 p-4">
        <h1 className="text-3xl font-bold text-gray-800 mb-4 mt-4 text-center">
          Ünite: {selectedUnit?.name}
        </h1>
        <p className="text-gray-700 mb-6 text-center">
          Öğrenci: <span className="font-semibold">{selectedStudent?.name} {selectedStudent?.surname}</span>
        </p>

        {/* Soru Kutucukları */}
        <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-4xl mb-6 grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 lg:grid-cols-12 gap-3 max-h-40 overflow-y-auto">
          {unitQuestions.map((q, index) => (
            <button
              key={q.id}
              onClick={() => handleQuestionBoxClick(index)}
              className={`w-12 h-12 flex items-center justify-center rounded-lg shadow-md font-bold text-white text-lg transition-colors
                ${getQuestionBoxColor(q.id)}
                ${currentQuestionIndex === index ? 'ring-4 ring-blue-400' : ''}
              `}
            >
              {index + 1}
            </button>
          ))}
        </div>

        {/* Soru Alanı */}
        {currentQuestion && (
          <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl space-y-6">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-2xl font-bold text-gray-800">Soru {currentQuestionIndex + 1}</h2>
              <div className="text-3xl font-bold text-blue-600">
                {timer} <span className="text-xl">sn</span>
              </div>
            </div>

            <p className="text-xl text-gray-900 font-medium mb-6">{currentQuestion.text}</p>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {['A', 'B', 'C', 'D'].map((optionKey) => (
                <button
                  key={optionKey}
                  onClick={() => !showResult && handleAnswerSubmit(optionKey)}
                  className={`p-4 rounded-lg shadow-md text-left text-lg font-semibold transition-all duration-200
                    ${showResult
                      ? (optionKey === currentQuestion.correctAnswer
                        ? 'bg-green-200 border-2 border-green-600 text-green-800' // Doğru cevap
                        : (selectedOption === optionKey
                          ? 'bg-red-200 border-2 border-red-600 text-red-800' // Yanlış seçilen cevap
                          : 'bg-gray-100 border border-gray-300 text-gray-700')) // Diğer seçenekler
                      : (selectedOption === optionKey
                        ? 'bg-blue-100 border-2 border-blue-500 text-blue-700' // Seçili olan
                        : 'bg-gray-100 border border-gray-300 text-gray-700 hover:bg-gray-200') // Normal
                    }
                    ${showResult ? 'cursor-not-allowed' : 'cursor-pointer'}
                  `}
                >
                  <span className="font-bold mr-2">{optionKey}:</span> {currentQuestion.options[optionKey]}
                </button>
              ))}
            </div>

            {showResult && (
              <div className="mt-6 text-center">
                {isAnswerCorrect ? (
                  <p className="text-green-600 text-2xl font-bold">Doğru Cevap! (+{answeredQuestions[currentQuestion.id]?.score} Puan)</p>
                ) : (
                  <p className="text-red-600 text-2xl font-bold">Yanlış Cevap! ({answeredQuestions[currentQuestion.id]?.score} Puan)</p>
                )}
                {isAnswerCorrect && answeredQuestions[currentQuestion.id]?.bonus > 0 && (
                  <p className="text-blue-600 text-lg font-semibold">({answeredQuestions[currentQuestion.id]?.bonus} Bonus Puan!)</p>
                )}
              </div>
            )}

            <div className="flex justify-between mt-6">
              <button
                onClick={handleNextQuestion}
                disabled={!showResult && timer > 0} // Cevap gösterilmeden veya süre dolmadan sonraki soruya geçilemez
                className={`px-6 py-3 rounded-md font-semibold transition-colors
                  ${(!showResult && timer > 0) ? 'bg-gray-300 text-gray-600 cursor-not-allowed' : 'bg-indigo-600 text-white hover:bg-indigo-700'}
                `}
              >
                Sonraki Soru
              </button>
              <button
                onClick={handleSkipQuestion}
                disabled={showResult} // Cevap gösteriliyorsa atlanamaz
                className={`px-6 py-3 rounded-md font-semibold transition-colors
                  ${showResult ? 'bg-gray-300 text-gray-600 cursor-not-allowed' : 'bg-yellow-600 text-white hover:bg-yellow-700'}
                `}
              >
                Soruyu Atla
              </button>
            </div>
          </div>
        )}

        <button
          onClick={() => setCurrentView('unitSelection')}
          className="w-full max-w-sm mt-8 bg-gray-500 text-white py-3 rounded-md hover:bg-gray-600 transition-colors font-semibold"
        >
          Ünite Seçimine Geri Dön
        </button>
      </div>
    );
  }, [selectedUnit, selectedStudent, questions, appSettings, modal]);


  // Uygulama Yükleniyor Durumu
  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200">
        <div className="text-blue-700 text-2xl font-semibold">Yükleniyor...</div>
      </div>
    );
  }

  // Ana Uygulama Render'ı
  return (
    <FirebaseContext.Provider value={{ db, auth, userId, appId }}>
      <div className="font-inter antialiased">
        {currentView === 'main' && <MainScreen />}
        {currentView === 'studentSelection' && <StudentSelection initialMode={initialStudentViewMode} />}
        {currentView === 'settings' && <Settings db={db} userId={userId} appSettings={appSettings} students={students} units={units} questions={questions} setModal={setModal} modal={modal} handleUpdateSetting={handleUpdateSetting} setCurrentView={setCurrentView} />}
        {currentView === 'unitSelection' && <UnitSelectionScreen />}
        {currentView === 'quizPlay' && <QuizPlayScreen />}
        {currentView === 'tools' && <ToolsScreen />}
        {currentView === 'studentManagement' && <StudentManagement db={db} userId={userId} students={students} setModal={setModal} modal={modal} setCurrentView={setCurrentView} />}
        {currentView === 'questionManagement' && <QuestionManagement db={db} userId={userId} units={units} questions={questions} setModal={setModal} modal={modal} setCurrentView={setCurrentView} />}


        <Modal
          isOpen={modal.isOpen}
          onClose={modal.onClose}
          title={modal.title}
          message={modal.message}
          onConfirm={modal.onConfirm}
          showConfirmButton={modal.showConfirmButton}
        />
      </div>
    </FirebaseContext.Provider>
  );
}

